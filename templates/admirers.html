{% extends "base.html" %}
{% block content %}

{% load fbdater_extras %}

<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/themes/base/jquery-ui.css">
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
	<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>

<div id="credit_check_modal" title="Premium Feature Purchase"></div>

<script type="text/javascript">

$(document).ready(function() 
{
			var
        $("#credit_check_modal").dialog({modal: true, autoOpen: false});
				$('.lineup').on('click',function(e) {
					credit_check_element=$(this).children('.check_credit');
        	var success_path=credit_check_element.attr('success_path');	
        	var cancel_url = credit_check_element.attr('cancel_url');
        	// return from paypal adds an extra trailing slash to cancel_url, so make sure it doesn't already have one
        	if(cancel_url.substr(-1) == '/') 
        		cancel_url = cancel_url.substr(0, cancel_url.length - 1);
        	var feature_id=credit_check_element.attr('feature_id');
        	load_url="/credit_checker/" + feature_id + "/?success_path=" + success_path + "&cancel_url=" + cancel_url;
            e.preventDefault();
			$("#credit_check_modal").load(load_url)   	
            $("#credit_check_modal").dialog("open");
            return false;
        });
});
</script>

<!-- Display the crush type navigation widget -->  
<HR>
<font color="gray">
{% if admirer_type = 0 %}
<b>Secret Admirers ({{admirer_relationships.count}})</b>&nbsp;&nbsp;<a href="/admirers_past">Past Admirers ({{past_admirers_count}})</a>
{% else %}
<a href="/admirers">Secret Admirers ({{progressing_admirers_count}})</a><b>&nbsp;&nbsp;Past Admirers ({{admirer_relationships.count}})</b>
{% endif %}
</font>
<BR><BR>
  
<! -- End of crush type navigation widget -->  

{% if admirer_relationships %}
	<ul>
		{% for admirer_rel in admirer_relationships %}
			<li> Secret Admirer #{{admirer_rel.admirer_display_id}} (added {{admirer_rel.date_added|datetime_since}} ago) ({{admirer_rel.source_person.first_name}} {{admirer_rel.source_person.last_name}} - <small>{{admirer_rel.source_person.facebook_username}})</small><BR> 
			<div id="{{admirer_rel.admirer_display_id}}" class="lineup">
			<!--  
			<BR><img src="http://graph.facebook.com/{{ admirer_rel|admirer_lineup_username:"0"}}/picture" height=40 width=40> <img src="http://graph.facebook.com/{{ admirer_rel|admirer_lineup_username:"1" }}/picture" height=40 width=40>
			{% for x in "xxxxxxxx" %}
				<img src = "http://a3.twimg.com/profile_images/1649076583/facebook-profile-picture-no-pic-avatar_reasonably_small.jpg" height =40 width = 40>
			{% endfor %}
			<BR>
			
			{% if admirer_rel.is_lineup_paid %}
				{% if admirer_rel.date_lineup_finished %}
					Line-up completed {{ admirer_rel.date_lineup_finished }}
					<a href="/lineup/{{admirer_rel.admirer_display_id}}/">View Completed Lineup</a>
				{% else %}
					<a href="/lineup/{{admirer_rel.admirer_display_id}}/">Finish Lineup</a>
				{% endif %}
			{% else %}
				<a class="check_credit" href="#" feature_id="1" cancel_url="{{request.build_absolute_uri}}" success_path="/lineup/{{admirer_rel.admirer_display_id}}">Start Lineup</a>
			{% endif %}
			-->
			</div>

			<BR><BR>
		{% endfor %}
			<script type="text/javascript">

  		$(".lineup").each(function(index) {
  		 var this_element = $(this);
  		 var this_id = this.id;
  		  // call load every 1 second until it returns content
  		 callback = function(response,status,xhr){
					if (status=="error"){
					  setTimeout(function(){
							this_element.load('/ajax_display_lineup/' + this_id,callback);
						},1000);
					} 
  		 };
  		 this_element.load('/ajax_display_lineup/' + this_id,callback);  
			});
			</script>
		
	</ul>
{% else %}
	THERE ARE NO {% if admirer_type = 0 %} CURRENT {% else %} PAST {% endif %} SECRET ADMIRERS!
{% endif %}


{% endblock %}
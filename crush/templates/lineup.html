{% load fbdater_extras %}
<div id="dialog_attraction_add" title="Attraction Confirmation "></div>
<div id="dialog_platonic_add" title="Not Interested Confirmation"></div>
<link href="{{ STATIC_URL }}bxSlider/jquery.bxslider.css" rel="stylesheet" />
<script src="{{ STATIC_URL }}bxSlider/jquery.bxslider.js"></script>

<!--  
<h2>Lineup for secret admirer id: {{admirer_rel.admirer_display_id}} ({{admirer_rel.source_person.first_name}} {{admirer_rel.source_person.last_name}})</h2>
 -->
<div id="lineup_container">
<div id="lineup-header">
One of these line-up members is your secret admirer!  Add any as a crush, and we'll let you know if the feeling is mutual.  All added crushes are
kept anonymous. They receive a lineup - with you in it!
</div>
 <div id="bx-pager">
 
{% for member in member_set %}

	{% if member.decision != None or forloop.counter0 == 0 %}
		<a data-slide-index="{{forloop.counter0}}" href=""><img src="http://graph.facebook.com/{{member.username}}/picture?type=large" width="50px" height="50px" /></a>
	{% else %}
			<img lineup_position={{forloop.counter0}} title="you cannot jump ahead in the lineup" src="http://a3.twimg.com/profile_images/1649076583/facebook-profile-picture-no-pic-avatar_reasonably_small.jpg" width="50px" height="50px" />
	{% endif %}
{% endfor %}
</div>  <!--  close off bx-pager div -->
<!-- Just a shell for the slideshow container -->

<ul class="bxslider" style="display:none">

{% for member in member_set %}
	{% if member.decision != None %}
		
	<li id="preload" lineup_position = {{member.position}} style="height:230px">
	
	 <div id="name">{{member.user.first_name}} {{member.user.last_name}}</div>
   <div id="mugshot" style="width:80px;height:80px"><img src="{{member.user.get_facebook_picture}}" height="80" width="10"/></div>
   <div id="position_info"><span>member {{forloop.counter}} out of {{member_set.count}}<span></div>
   <div id="facebook_link"><a href="http://www.facebook.com/{{member.username}}" target="_blank">view facebook profile</a></div>
   <div id="decision" username="{{member.username}}">
		{% if member.decision == 0 %}

       <div id="choice" class="crush">You added {{member.user.first_name}} {{member.user.last_name}} as a crush!</div>
		{% else %}
       <div id="choice">You added {{member.user.first_name}} {{member.user.last_name}} as a platonic friend.</div>
    {% endif %}
    </div> <!--   close off decision tag -->
	{% else %}	
	<li id="lineup" lineup_position="{{member.position}}" style="height:230px">
	{% endif %}
</li>

{% endfor %}
</ul>
</div>  <!--  close off lineup_container -->

<div id="lineup-footer">
<div id="footer-msg"></div>
<button id="finish-btn" type="button" disabled>Finish</button>
</div>

<script type="text/javascript">
$(document).ready(function() // handling for the slider
{ 

	/** PROCEDURAL CODE - CREATE IS_LINEUP_PAID GLOBAL
	* create global bool variable for lineup's is_lineup_paid setting
	*/
	window.is_lineup_paid = '{{admirer_rel.is_lineup_paid}}';
	if (window.is_lineup_paid == 'True')
		window.is_lineup_paid=true;
	else
		window.is_lineup_paid=false;
		
			
	/* ----------------------------------------------------------------------
	*		FUNCTION - PROCESS COMPLETED LINEUP
  *		enable finish button and add footer summary message
	*  ---------------------------------------------------------------------- */
	var process_completed_lineup = function(){
		footer_element=$('#lineup_modal #lineup-footer');
		footer_element.children('#finish-btn').removeAttr('disabled');
	  footer_msg_element = footer_element.children('#footer-msg');
	  footer_msg_element_html='<b>Your Crush Lineup evaluation is complete!</b>'
	 	crush_li_elements = $('.bxslider li#preload').has('#decision .crush');
	 	total_crushes=crush_li_elements.length;
	 	if (total_crushes > 0){ 
	 		footer_msg_element_html += '<BR> <b>Added to crush list (' + total_crushes + '):</b>';
		  crush_li_elements.each(function(index,item){
				footer_msg_element_html += ' ' +$(item).children('#name').html();
				if (index < (total_crushes - 1))
					footer_msg_element_html += ',';	
		  });
		}
		footer_msg_element.html(footer_msg_element_html);
	};
	
	/* ----------------------------------------------------------------------
	*		FUNCTION - UPDATE FOOTER MESSAGE
  *		called everytime a slide load is completed
	*  ---------------------------------------------------------------------- */
		var updateFooterMsg = function(){
		footer_msg_element=$('#lineup_modal #lineup-footer #footer-msg');
		// number of evaluated members
		var decided_li_elements = $('.bxslider li#preload #decision #choice');	
	 	var total_decisions=decided_li_elements.length;
		// total members
		var total_members="{{member_set.count}}";
	  footer_msg_element.html('<div id="progressing">evaluated ' + total_decisions + ' of ' + total_members + ' members</div>');
	};

	/* ----------------------------------------------------------------------
	*		FUNCTION - LAUNCH SLIDER
  *		Launch the slider at a parameterized position
	*  ---------------------------------------------------------------------- */		

	var launch_slider_at = function(last_loaded_slide){
		window.slider_control = $('.bxslider').bxSlider({
			pagerCustom: '#bx-pager',
			infiniteLoop: false,
			hideControlOnEnd: false,
			speed:800,
			adaptiveHeight:true,
			startSlide: 0,
			slideSelector:'li#preload',
			onLastSlideNext: window.handleLastSlideNext
			});
		$('#lineup_container').find('.bxslider').show();
		setTimeout(function(){window.slider_control.goToSlide(last_loaded_slide)},500);
		updateFooterMsg();
	};	
		
	/* ----------------------------------------------------------------------
	*		FUNCTION - AJAX LOAD NEXT SLIDE
  *		Ajax load the next slide into the DOM
	*  ---------------------------------------------------------------------- */			
	var load_next_slide = function(next_position, callback){
		var load_url = '/ajax_get_lineup_slide/{{admirer_rel.admirer_display_id}}/' + next_position + '/';
		$('.bxslider li[lineup_position=' + next_position + ']').load(load_url, function(responseText, textStatus, xhr) {
			if (textStatus!='success'){
				if (xhr.status==405){
					reauthorize_user();
					return;
				}
				$(this).dialog("close");
				window.alert_user("{{ajax_error}}");
				return false;
			}
			// load the next thumbnail as well
			var next_username =$(this).find('#decision').attr("username");
			var new_src = 'http://graph.facebook.com/' + next_username + '/picture?type=large';
			var img_element = $('#bx-pager img[lineup_position=' + next_position + ']')

			img_element.attr('src', new_src).attr('width','50').attr('height','50');	
			img_element.wrap('<a data-slide-index="' + next_position + '" href="">');
			callback(next_position);
				// add the fake next button if we're not at the last slide
			}).attr("id", "preload"); // close off ajax load of next slide
	}; // close off of helper function: load_next_slide
	
	/* ----------------------------------------------------------------------
	*		FUNCTION - RESET SLIDER
  *		reset the slider (if # slides changed) and advance it to last slide
	*  ---------------------------------------------------------------------- */		
	var resetAndAdvanceSlider = function(just_loaded_slide){
		window.slider_control.reInitialize();						
		setTimeout(function(){
			window.slider_control.goToSlide(just_loaded_slide);
		},1000);
	}; // close off resetAndAdvanceSlider

	/* ----------------------------------------------------------------------
	*		FUNCTION - HANDLE ADD ATTRACTION/Platonic CLICK
  *		handle click to 'add member' as crush or platonic friend
	*  ---------------------------------------------------------------------- */
	var attraction_dialog = $("#dialog_attraction_add");
	attraction_dialog.dialog({modal: true, autoOpen: false});
  attraction_dialog.on('click', function(e){e.stopPropagation();});
	var dialog_attraction_html = '<input type="checkbox" checked>By clicking submit, you agree to all <a href="/help_terms" target="_blank">terms & conditions</a></input>';
  
  var platonic_dialog = $("#dialog_platonic_add");
	platonic_dialog.dialog({modal: true, autoOpen: false});
  platonic_dialog.on('click', function(e){e.stopPropagation();});
  var dialog_platonic_html = '<span id="platonic_add_text">Please tell us how you would rate their attractiveness to a friend of yours?</span><BR>';
			dialog_platonic_html += '<input type="radio" name="rating" value="5"checked>{{rating5}}</input><BR>';
			dialog_platonic_html += '<input type="radio" name="rating" value="4">{{rating4}}</input><BR>';
			dialog_platonic_html += '<input type="radio" name="rating" value="3">{{rating3}}</input><BR>';
			dialog_platonic_html += '<input type="radio" name="rating" value="2">{{rating2}}</input><BR>';
	  	dialog_platonic_html += '<input type="radio" name="rating" value="1">{{rating1}}</input><BR>';
  
  $('#lineup_container li').on('click','a.decision',function(e) {
		e.preventDefault();
		var this_element = $(this);
  	var decision_div = this_element.parent(); 
	  var url,decision_dialog,crush_decision;
	  if (this_element.attr('add_type')=="crush") {
	  	url = "/ajax_add_lineup_member/crush/{{admirer_rel.admirer_display_id}}/" +  this_element.attr('username') + "/"; 
	  	decision_dialog = attraction_dialog;
	  	decision_dialog.html(dialog_attraction_html);
	  	crush_decision=true;
	  }
	  else {
	  	url = "/ajax_add_lineup_member/platonic/{{admirer_rel.admirer_display_id}}/" + this_element.attr('username') + "/"; 
	  	decision_dialog = platonic_dialog;
	  	decision_dialog.html(dialog_platonic_html);
	  	crush_decision=false;
	  }

	  decision_dialog.dialog('option', 'buttons', {
				"Cancel": function() {	
					$(this).dialog("close");
				}, // end of cancel handler
				"Submit": function() {
					if (crush_decision==true){
					 	if (decision_dialog.children('input:checked').length == 0){
							window.alert_user("You must agree to the terms and conditions before continuing.");
							return;
						}
					}
					else {
						url += decision_dialog.children('input:radio[name="rating"]:checked').val();
					}	
					decision_div.prev().show();decision_div.hide();
					decision_div.load(url, function(responseText,textStatus,XHR){
						decision_div.prev().hide();decision_div.show()
						if (textStatus!='success'){					
							window.alert_user("{{ajax_error}}");
							return false;
						};

						goto_next_slide(decision_div.parent().attr('lineup_position'));
						}); // close off parent.load (making the decision and showing the html results		
					$(this).dialog("close"); // must destroy rather than close cause switching between two dialogs causes problems
					if (crush_decision==true) 
						$("#num_crushes_in_progress").load("/ajax_update_num_crushes_in_progress/");
					else 
						$("#num_platonic_friends").load("/ajax_update_num_platonic_friends/");
				}   // end of add handler
			}); // end of .dialog handler
    
    decision_dialog.dialog("open");

	}); // end of click handler: $('#lineup_container li').on('click','a.decision',function(e)
	
	var goto_next_slide = function(current_position)
	{

		var next_position = parseInt(current_position) + 1;
		if (next_position < {{member_set.count}})	{
			updateFooterMsg();
			// if the slide that was just decided on was the second one and is_lineup_paid=false, then auto launch the check dialog 
			if (current_position == 0 && !window.is_lineup_paid && {{member_set.count}} > 1)
				setTimeout(window.launch_credit_check,1000);
			else 
				load_next_slide(next_position.toString(), resetAndAdvanceSlider);	
		} // close off - if not at last slide
		else // enable finish button
			process_completed_lineup();
	};
	
	/* ----------------------------------------------------------------------
	*		FUNCTION - HANDLE SLIDER LAST NEXT CLICK
  *		callback handler for slider called when last next button is clicked
  *   checks to see if check-payment dialog should be launched (on second slide if lineup_paid is false)
	*  ---------------------------------------------------------------------- */
	window.handleLastSlideNext = function(activeSlideElement,activeIndex){
		// if active slide is last slide (which is 1) and no decision has been made yet, then launch credit check
		if (activeIndex == 0 && activeSlideElement.has('#choice').length && !window.is_lineup_paid){
			window.launch_credit_check();
		}
		else {
			if ((parseInt(activeIndex) + 1) < {{member_set.count}}){ 
				var member_name = activeSlideElement.children('#name').html();
				window.alert_user("Sorry, you can not jump ahead without making a decision on " + member_name);
			}
		}
	};
	
	/** PROCEDURAL CODE
	* Preload any slides that already have a decision
	*/

	var last_loaded_slide = $('.bxslider li#preload').length - 1;
	//var last_loaded_slide=-1;
	//$('.bxslider li#preload').each(function(index){
	//		$(this).load('/ajax_get_lineup_slide/{{admirer_rel.admirer_display_id}}/' + index + '/');	
	//		last_loaded_slide = index;
	//});

	/** PROCEDURAL CODE
	* possibly load the next upcoming slide if we are at first position or if lineup is already paid
	* then call the slider launching function
	*/
	var next_loaded_slide=last_loaded_slide+1;
	if (next_loaded_slide < {{member_set.count}}) { // we haven't decided on last member yet
		if (last_loaded_slide<0 || window.is_lineup_paid ) 	// we've only loaded 0 or 1 slide or lineup already paid, so load next automatically
				load_next_slide(next_loaded_slide,launch_slider_at);
		else // don't load slide after last, just open slider at last loaded position
				launch_slider_at(last_loaded_slide);		
	} // lineup isn't paid so just open slider with whatever was already decided
	else{
		launch_slider_at(0);
		process_completed_lineup(); // if lineup is finished then just process it
	}

	/* ----------------------------------------------------------------------
	*		FUNCTION - LAUNCH_CREDIT_CHECK
	*  ---------------------------------------------------------------------- */    
 	
 	window.launch_credit_check = function() {
		data = {};
		data['csrfmiddlewaretoken']="{{csrf_token}}";
		data['success_path'] = '/admirers/{{admirer_rel.admirer_display_id}}/';
		data['cancel_url'] = 'http://{{request.get_host}}/admirers/{{admirer_rel.admirer_display_id}}';
		data['unique_id'] = '{{admirer_rel.admirer_display_id}}';
		data['feature_id'] = '1';
		data['purchase_callback_name'] = 'window.lineup_purchased()';
		data['ajax_error']='{{ajax_error}}';
		purchase_feature(data);
   }; 
   
 	window.lineup_purchased = function(){
			$('#num_new_admirers').load('/ajax_update_num_new_admirers');
			next_position=parseInt(window.slider_control.getCurrentSlide()) + 1;
			load_next_slide(next_position,resetAndAdvanceSlider);
			window.is_lineup_paid=true;
		}; 
	 

	/* ----------------------------------------------------------------------
	*		FUNCTION - HANDLE FINISH BUTTON 
  *		
	*  ---------------------------------------------------------------------- */

	var handle_lineup_dialog_close = function(){
		var current_href=document.location.href;
		var decided_li_elements = $('.bxslider li#preload #decision #choice');	
	 	var total_decisions=decided_li_elements.length;
		
		if (current_href.indexOf("/admirers/") != -1) { // if user is on progressing admirers page, not on completed admirers page:
			// redirect user to crushes in progress if there is only one progressing lineup and it is done
				if (total_decisions == {{member_set.count}} && {{ request.user.get_progressing_admirers.count }} == 1)	
					document.location.href='/attractions/';
				else
					$('#lineup_modal').dialog("close");//closing of lineup modal automatically refreshes page
		}
	};
	$('#lineup_modal').on('click','#finish-btn',function(e) {
		handle_lineup_dialog_close();
	});
}); // close off jquery document ready

</script>



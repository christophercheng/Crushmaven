{% extends "base.html" %}
{% block title %}Admirers{% endblock %}
{% block content %}
{% load fbdater_extras %}
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38751299-1']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

<div id="lineup_modal" title="Attraction&trade; Lineup"></div>

<script type="text/javascript">
$(document).ready(function() 
{
    /** FUNCTION - HANDLE View Lineup Click
    *
    */
    $("#lineup_modal").dialog({position:{my:"left center",at:"right+20 center-100",of:'.left_sidebar_container .bt-fs-dialog'},modal: true, resizable:false,autoOpen: false,width:575,close:function(event,ui){location.reload();}});
    $('.admirer_block').on('click', '.view_lineup', function(e) {
        view_lineup_element=$(this);
		var display_id=view_lineup_element.attr('display_id');	
		
		$("#lineup_modal").html('<div id="site-loading"></div>');
		$("#lineup_modal").dialog("open");
		load_url="/ajax_show_lineup_slider/" + display_id + "/";
    e.preventDefault();
    $("#lineup_modal").load(load_url,function(responseText,textStatus,XHR){
		if (textStatus!='success'){
			$(this).dialog("close");
			window.alert_user("{{ajax_error}}");
			return false;
			}
		});   
	  return false;    
	});			
  
    /** AUTOMATIC FUNCTION - WAIT FOR INITIALIZATION BEFORE RENDERING LINEUP BLOCK
    *
    */
    $('.ajax_display_lineup_block').each(function(){

        var admirer_display_id=$(this).attr("display_id");
        var lineup_block_div = $(this).parent('.lineup_block');
        lineup_block_div.html('<div id="loading">initializing lineup...</div>');
        var ajax_url = '/ajax_display_lineup_block/' + admirer_display_id + '/'; 
        var ajax_fail_url='/ajax_initialization_failed/' + admirer_display_id + '/';
        $.ajax(ajax_url, {
        
   				timeout: 90000, // 90 seconds - purposely set high so the server can time out by itself
   				success: function (data) {
       			lineup_block_div.html(data);
   				},
   				error: function(){
   					lineup_block_div.html("{{fof_fail_status}}");
   					$.get(ajax_fail_url);
   				} 
				});
    });
    
	// auto show lineup if one given
	var show_lineup_number = '{{show_lineup}}';   
	if (show_lineup_number)
        $('.view_lineup[display_id="{{show_lineup}}"]').trigger('click'); 

	//handle help icon show and hide
	$('.admirer_block_instructions').each(function(){window.scrollTo(0,0);$(this).delay(500).show(1000)});
//		$('.admirer_block_instructions').each(function(){window.scrollTo(0,0);$(this).show()});
	$('.admirer_block_instructions .help_icon').click(function(){
		$(this).parent().hide(500);
	});
}); // close off $(document).ready
</script>

<!-- Display the title widget -->  
<span class="title_line"></span>
<ul class="title_bar" id="title_bar_admirers">
	<li class="title_bar_title">Admirers</li>
	<li class="title_bar_option">
		sort:
		<a href="#">by status<span class="down_arrow">&#x25BC;</span></a>
	</li>
	<li class="title_bar_page_links">
		{% if admirer_type = 0  %}
			<span class="title_bar_page_link active_title_bar_page_link title_bar_page_first_link "><span id="page_link_pointer" class="lineup_incomplete_pointer"></span>lineup incomplete <span class="crush_count">({{admirer_relationships.count}})</span></span>
			<a class="title_bar_page_link inactive_title_bar_page_link" href="/admirers_past/">lineup finished <span class="crush_count">({{past_admirers_count}})</span></a>
		{% else %}
			<a class = "title_bar_page_link inactive_title_bar_page_link title_bar_page_first_link" href="/admirers/">lineup incomplete <span class="crush_count">({{progressing_admirers_count}})</span></a>
			<span class="title_bar_page_link active_title_bar_page_link"><span id="page_link_pointer" class="lineup_finished_pointer"></span>lineup finished <span class="crush_count">({{admirer_relationships.count}})</span></span>
		{% endif %}
	</li>
</ul>
<! -- End of crush type navigation widget -->  
   
{% comment %}
<span class="title_line"></span>
<ul class="title_bar" id="title_bar_admirers">
	<li class="title_bar_title">Admirers</li>
	<li class="title_bar_option">
		sort:
		<a href="#">by status<span class="down_arrow">&#x25BC;</span></a>
	</li>
	<li class="title_bar_option">
		filter:
		{% if admirer_type == 0 %}
		<a href="#">lineup incomplete<span class="down_arrow">&#x25BC;</span></a>
		<ul>
			<li>
				<a href="/admirers_past/">lineup completed ({{past_admirers_count}})</a>
			</li>
		</ul>
		{% else %}
		<a href="#">lineup completed ({{admirer_relationships.count}})<span class="down_arrow">&#x25BC;</span></a>
		<ul>
			<li>
				<a href="/admirers/">lineup incomplete ({{progressing_admirers_count}})</a>
			</li>
		</ul>
		{% endif %}
	</li>
</ul>
  
<!-- End of crush type navigation widget -->  

{% endcomment %}

{% if admirer_relationships %}

{% for admirer_rel in admirer_relationships %}
		{% if admirer_type == 0 and admirer_rel.admirer_display_id == 1 %}
		<p class="admirer_block_instructions">
				To protect your admirer's identity (in case you are not mutually attracted), we have created a lineup of potential attractors 
				and inserted your admirer in a random position.  You may view each lineup member (revealed one-at-a-time) and select any as an attraction.  
				<span class="second_instruction_section">In turn, we provide each of your selections with a similar lineup experience - and the option to select you. You are notified if there is a mutual attraction or not.</span>
		<span class="help_icon" title="close help"></span>
		</p>		<!-- close off admirer_block line for instructional content -->
		{% endif %}

	<div class="admirer_block" display_id="{{admirer_rel.admirer_display_id}} ">
		<div class="admirer_block_line admirer_block_first_line">
			<img class="admirer_cloaked_pic" src = "http://a3.twimg.com/profile_images/1649076583/facebook-profile-picture-no-pic-avatar_reasonably_small.jpg">
			<div class="admirer_title">
				Secret Admirer #{{admirer_rel.admirer_display_id}}	
				{% if admirer_rel.friendship_type == 0 %} 
					<span class="admirer_connection_info">(a friend of yours)</span> 
				{% elif admirer_rel.friendship_type == 1 %}
					<span class="admirer_connection_info">(you share a mutual facebook friend)</span>
				{% else %}
					<span class="admirer_connection_info">(you have no facebook friends in common)</span>
				{% endif %}
			</div><!-- close off secret admirer title -->
		</div><!-- close off admirer_block line -->

		<div class="admirer_block_line lineup_block" display_id="{{admirer_rel.admirer_display_id}}">
			{% if admirer_rel.lineup_initialization_status == 1 %}
					{% with admirer_rel as relationship %}
					 	{% include "lineup_block.html" %}
					{% endwith %}
				{% else %}
				     <div class="ajax_display_lineup_block" display_id="{{admirer_rel.admirer_display_id}}"></div>		
				{% endif %}
		</div><!-- close off admirer_block line -->
		<div class="admirer_block_line admirer_block_footer">
		
		{% if relationship.date_lineup_finished != None %}
			lineup completed {{relationship.date_lineup_finished}}
		{% else %}
			added {{admirer_rel.date_added|datetime_since}} ago
		{% endif %}
		</div><!-- close off admirer_block line -->
	</div><!--  close off admirer block -->
{% endfor %}

{% else %}
	{% if admirer_type = 0 %}
		<span id="no_content">You have no current admirers.</span>
	{% else %}
		<span id="no_content">You have no admirers with completed lineups.</span>
	{% endif %}
{% endif %}

{% endblock %}
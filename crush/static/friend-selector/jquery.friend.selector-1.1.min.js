/*
 * Facebook Friend Selector
 * Copyright (c) 2011 Coders' Grave - http://codersgrave.com
 * Version: 1.1
 * Requires:
 *   jQuery v1.6.2 or later
 *   Facebook Integration - http://developers.facebook.com/docs/reference/javascript/
 */
(function(g){var b={},i=false,d=0,a=0,j=1,l="",e="",k,c,f,h="http://developers.facebook.com/docs/reference/javascript/";defaults={max:null,excludeIds:[],closeOverlayClick:true,overlayOpacity:"0.3",overlayColor:"#000",closeOnSubmit:false,showSelectedCount:false,color:"default",lang:{title:"Friend Selector",buttonSubmit:"Send",buttonCancel:"Cancel",summaryBoxResult:"{1} best results for {0}",summaryBoxNoResult:"No results for {0}",searchText:"Enter a friend's name",fbConnectError:"You must connect to Facebook to see this.",selectedCountResult:"You have choosen {0} people.",selectedLimitResult:"Limit is {0} people."},maxFriendsCount:null,showRandom:false,facebookInvite:false,facebookInviteMessage:"Invite message",onStart:function(m){return null},onClose:function(m){return null},onSubmit:function(m){return null}},_start=function(){if(typeof FB=="undefined"){alert("Facebook integration is not defined. View "+h);return false}b=g.extend(true,{},defaults,b);if(b.max>0&&b.max!=null){b.showSelectedCount=true}_dialogBox();b.onStart()},_close=function(){c.fadeOut(400,function(){k.empty();c.remove();_stopEvent();f.fadeOut(400,function(){f.remove()})});i=false;b.onClose()},_submit=function(){var m=[];g(".fs-friends:checked").each(function(){var o=g(this).val().split("-");var p=o[1];m.push(parseInt(p))});if(b.facebookInvite==true){var n="";g.each(m,function(p,o){n+=o+","});n=n.substr(0,n.length-1);FB.ui({method:"apprequests",message:b.facebookInviteMessage,to:n},function(o){if(o!=null){b.onSubmit(m);if(b.closeOnSubmit==true){_close()}}})}else{b.onSubmit(m);if(b.closeOnSubmit==true){_close()}}},_dialogBox=function(){if(i==true){return}i=true;g("body").append(f=g('<div id="fs-overlay"></div>'),c=g('<div id="fs-dialog-box-wrap"></div>'));c.append('<div class="fs-dialog-box-bg" id="fs-dialog-box-bg-n"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-ne"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-e"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-se"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-s"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-sw"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-w"></div><div class="fs-dialog-box-bg" id="fs-dialog-box-bg-nw"></div>');c.append(k=g('<div id="fs-dialog-box-content"></div>'));var m="";m+='<div class="fs-dialog fs-color-'+b.color+'">';m+='  <h2 class="fs-dialog-title"><span>'+b.lang.title+"</span></h2>";m+='  <div class="fs-filter-box">';m+='    <div class="fs-input-wrap">';m+='      <input type="text" class="fs-input-text" title="'+b.lang.searchText+'" />';m+='      <a href="javascript:{}" class="fs-close-small">Reset</a>';m+="    </div>";m+="  </div>";m+='  <div class="fs-user-list">';m+="    <ul></ul>";m+="  </div>";m+='  <div class="fs-dialog-buttons">';m+='    <a href="javascript:{}" class="fs-button fs-submit-button"><span>'+b.lang.buttonSubmit+"</span></a>";m+='    <a href="javascript:{}" class="fs-button fs-cancel-button"><span>'+b.lang.buttonCancel+"</span></a>";m+="  </div>";m+="</div>";g(".fs-cancel-button").live("click.fs",function(){_close()});g(".fs-submit-button").live("click.fs",function(){_submit()});g(".fs-cancel-button").live("click.fs",function(){_close()});k.html(m);_getFacebookFriend();_resize(true);_initEvent();g(window).resize(function(n){_resize(false)})},_getFacebookFriend=function(){g(".fs-user-list").append('<div id="fs-loading"></div>');FB.api("/me/friends",function(n){if(n.error){alert(b.lang.fbConnectError);_close();return false}var m=n.data;var o=b.maxFriendsCount!=null&&b.maxFriendsCount>0;if(b.showRandom==true||o==true){m=_shuffleData(n.data)}g.each(m,function(r,q){if(o&&b.maxFriendsCount<=r){return false}if(g.inArray(parseInt(q.id),b.excludeIds)>=0){return true}var u=g("<li />");var p=g('<input class="fs-fullname" type="hidden" name="fullname[]" value="'+q.name.toLowerCase().replace(/\s/gi,"+")+'" />');var w=g('<input class="fs-friends" type="checkbox" name="friend[]" value="fs-'+q.id+'" />');var x=g('<img class="fs-thumb" src="https://graph.facebook.com/'+q.id+'/picture" />');var s=g('<span class="fs-name" />').text(_charLimit(q.name,15));var t=g('<a class="fs-anchor" />',{href:"javascript:{}"}).append(p,w,x,s).appendTo(u);g(".fs-user-list ul").append(u)});g("#fs-loading").remove()})},_initEvent=function(){g(".fs-dialog input").focus(function(){if(g(this).val()==g(this)[0].title){g(this).val("")}}).blur(function(){if(g(this).val()==""){g(this).val(g(this)[0].title)}}).blur();g(".fs-dialog input").keyup(function(m){_find(g(this))});g(".fs-close-small").bind("click.fs",function(m){g(".fs-input-text").val("");_find(g(".fs-dialog input"))});g(".fs-user-list li").live("click.fs",function(o){if(g(this).hasClass("checked")){g(this).removeClass("checked");g("input",this).attr("checked",false);j--}else{if(j>b.max&&b.max!=null){var n=b.lang.selectedLimitResult.replace("{0}",b.max);g(".fs-limit").html('<span class="fs-limit fs-full">'+n+"</span>");return false}j++;g(this).addClass("checked");g("input",this).attr("checked",true)}if(j>1&&b.showSelectedCount==true){var m=b.lang.selectedCountResult.replace("{0}",(j-1));if(!g(".fs-dialog").has(".fs-summary-box").length){g(".fs-filter-box").after('<div class="fs-summary-box"><span class="fs-limit fs-count">'+m+"</span></div>")}else{if(!g(".fs-dialog").has(".fs-limit.fs-count").length){g(".fs-summary-box").append('<span class="fs-limit fs-count">'+m+"</span>")}else{g(".fs-limit").text(m)}}}else{if(e==""){g(".fs-summary-box").remove()}else{g(".fs-limit").remove()}}});g(document).keyup(function(m){if(m.which==27){_close()}});if(b.closeOverlayClick==true){f.css({cursor:"pointer"});f.bind("click.fs",_close)}},_stopEvent=function(){g(".fs-close-small").unbind("click.fs");g(".fs-user-list li").die("click.fs");j=1;g(".fs-cancel-button").die("click.fs");g(".fs-submit-button").die("click.fs")},_charLimit=function(o,m){var n=o.length;if(n<=m){return o}return o.substr(0,m)+"..."},_find=function(n){var o=n.parents(".fs-dialog");e=g.trim(n.val());search_text=e.toLowerCase().replace(/\s/gi,"+");var p=o.find(".fs-user-list ul li .fs-fullname[value*="+search_text+"]");var m=o.find(".fs-user-list ul");m.children().hide();g.each(p,function(s,r){g(this).parents("li").show()});if(p.length>0&&e>""){var q=b.lang.summaryBoxResult.replace("{0}",'"'+n.val()+'"');q=q.replace("{1}",p.length)}else{var q=b.lang.summaryBoxNoResult.replace("{0}",'"'+n.val()+'"')}if(!o.has(".fs-summary-box").length){g(".fs-filter-box").after('<div class="fs-summary-box"><span class="fs-result-text">'+q+"</span></div>")}else{if(!o.has(".fs-result-text").length){g(".fs-summary-box",o).prepend('<span class="fs-result-text">'+q+"</span>")}else{g(".fs-result-text",o).text(q)}}if(e==""){if(o.has(".fs-summary-box").length){if(j==1){g(".fs-summary-box",o).remove()}else{g(".fs-result-text",o).remove()}}}},_resize=function(p){d=g(window).width();a=g(window).height();docHeight=g(document).height();var q=c.width();var n=c.height();var o=(d/2)-(q/2);var m=(a/2)-(n/2);if(p==true){f.css({"background-color":b.overlayColor,opacity:b.overlayOpacity,height:docHeight}).fadeIn("fast",function(){c.css({left:o,top:m}).fadeIn()})}else{c.stop().animate({left:o,top:m},200);f.css({height:docHeight})}},_shuffleData=function(p){for(var n,m,o=p.length;o;n=parseInt(Math.random()*o),m=p[--o],p[o]=p[n],p[n]=m){}return p};g.fn.fSelector=function(m){g(this).unbind("click.fs");g(this).bind("click.fs",function(n){b=m;_start()});return this}})(jQuery);
{% load fbdater_extras %}
<!-- Javascript to help the form validate via ajax without reloading entire page -->
<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/themes/base/jquery-ui.css">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
		<script type="text/javascript" src="{{ STATIC_URL }}friend-selector/jquery.friend.selector-1.2.js"></script>
<script>
$(document).ready(function() 
{
	window.recommendation_target="";
	window.recommendation_recommendee_array=[];
	window.recommendation_recommendee_csl;
	
	$(".recommendation_selector").fSelector({ // call the .fSelector function and send it a massive dictionary of option values
	  accessToken: "{{request.user.access_token}}",
	  facebookID: "{{request.user.username}}",
	  malePref:null,// {% if request.user.gender_pref = 'F' %} false {% elif request.user.gender_pref = 'M' %} true {% else %} null{% endif %},
    maleGender: {% if request.user.gender = 'F' %} false {% elif request.user.gender_pref = 'M' %} true {% else %} null{% endif %},
    minimum_samegender_friends:"0",//"{{minimum_samegender_friends}}",
    minimum_crushgender_friends:"0",//"{{minimum_crushgender_friends}}",
	  excludeIds: "{% for crush_rel in request.user.crush_crushrelationship_set_from_source.all %}{{crush_rel.target_person.username}}{% if not forloop.last %},{% endif %}{% endfor %}",
    closeOverlayClick: false,
    overlayOpacity: "0.5",
    overlayColor: '#000',
    closeOnSubmit: true,
    showSelectedCount: true,
    color: "default",
    showRandom:false,
    lang: {
      title: "Add Attractions",
      searchText: "Enter a friend's name",
      fbConnectError: "You must be logged in to Facebook in order to use this feature.",
      selectedCountResult: "You have choosen {0} people.",
      selectedLimitResult: "Limit is {0} people.",
      ajaxError:"{{ajax_error}}",
    },

    onError: function(){
    	window.alert_user("{{ajax_error}}");
    },
    onClose: function(){
    	//$(".recommendation_create_dialog").show();
    	//$(".ui-widget-overlay").show();
    },
    onStart: function(){
      //$(".recommendation_create_dialog").hide();
    	//$(".ui-widget-overlay").hide();
    	 $("#fs-dialog-box-wrap").draggable({handle:"#fs-dialog-title"});
    	 window.scrollTo(0,0); // hack to allow dialog to show - cause it always loads relative to fixed elements
    	 //$('body').css('overflow-y','hidden !important');
   
    },
    });
    
  window.process_selected_target = function(response){
		window.recommmendation_target= response[0].toString();
  	window.recommendation_target = window.recommmendation_target.substring(0,window.recommmendation_target.length-1);
  	$('.recommendation_target_pic').attr('src',"http://graph.facebook.com/" + window.recommendation_target + "/picture?width=60&height=60");
  	$('button#select_recommendation_target').attr('getStoredFriends',window.recommendation_target);
  	$('button#select_recommendation_recommendees').attr('excludeIds',window.recommendation_target);
		$('#select_recommendation_recommendees').removeAttr('disabled');
		$('#target_username_input').attr('value',window.recommendation_target);
  }
  
  // exclude anyone already added as a recommendee
  window.process_selected_recommendees = function(response){
		window.recommmendation_recommendee_array=[];
		window.recommendation_recommendee_csl="";
		var array_csl="";
		for (var x=0;x<response.length;x++){
			var username = response[x].toString();
	  	username = username.substring(0,username.length-1);
	  	window.recommendation_recommendee_array.push(username);
	  	$('#recommendee_pic_' + x.toString()).attr('src',"http://graph.facebook.com/" + username + "/picture?width=40&height=40");
  		if (x != 0)
  			window.recommendation_recommendee_csl += ',';
  		window.recommendation_recommendee_csl += username;
  	}
  	for (var x=response.length;x<10;x++)
	  	$('#recommendee_pic_' + x.toString()).attr('src',"http://a3.twimg.com/profile_images/1649076583/facebook-profile-picture-no-pic-avatar_reasonably_small.jpg");
 	 $('button#select_recommendation_recommendees').attr('getStoredFriends',array_csl);
 	 $('button#select_recommendation_target').attr('excludeIds',window.recomendation_recommendee_csl);
 	 $('.recommendation_create_dialog .ui-dialog-buttonpane .ui-dialog-buttonset button.site_dialog_button').removeAttr('disabled');
   $('#recommendee_username_csl_input').attr('value',window.recommendation_recommendee_csl);
  }
 
 $("#create_setup").click(function(){
   	FB.ui({method: 'send',
  				name: "{{request.user.first_name}} {{request.user.last_name}} has selected some  friends of {{request.user.get_gender_pronoun}} which {{request.user.get_gender_pronoun_subject }} think you may find attractive.",
  				to: window.recommendation_target,
  				link:'http://www.justmaybe.us',
  				description:'JustMaybe.us is a new matchmaking service that allows friends to easily set their friends up with eachother.'
      },
      function(response){
         // regardless of whether user cancels or sends message, reload the appropriate attraction page
         if (response != null){
				  	$('#recommendation_form').submit();
  				}
  			else {
  				window.alert_user("We cannot create this set up unless you notify your friend");
  				//$('#recommendation_form').submit();
  			}
  		} // close off function (response)   
    );// close off fb.ui
 });

		
}); // close off document ready function
</script>

<form id="recommendation_form" action="http://{{request.get_host}}{% url 'crush.views.recommendation_create_form' %}" method="post">
		{% csrf_token %}
    <div id="recommendation_target_section">
			<div class="dialog_header active_dialog_header">
				Step 1: <span class="dialog_header_sentence">Select a friend to set up</span>
			</div>
			<img class="recommendation_target_pic" src = "http://a3.twimg.com/profile_images/1649076583/facebook-profile-picture-no-pic-avatar_reasonably_small.jpg">
			<button class="recommendation_button recommendation_selector" max_selections="1" recommendation_select="true" onSubmit="window.process_selected_target" id="select_recommendation_target" type="button">select</button>
	  </div><!-- close recommendation_target_section -->
    <div id="recommendation_lineup_section">
			<div class="dialog_header inactive_dialog_header">
				Step 2: <span class="dialog_header_sentence">Select up to ten others to recommend to your friend</span>
			</div>
			{% for x in 10|get_range %}
				<img class="recommendation_recommendee_pic" src = "http://a3.twimg.com/profile_images/1649076583/facebook-profile-picture-no-pic-avatar_reasonably_small.jpg" id="recommendee_pic_{{forloop.counter0}}">
			{% endfor %}
			<button class="recommendation_button recommendation_selector" max_selections="10" recommendation_select="true" onSubmit="window.process_selected_recommendees" id="select_recommendation_recommendees" type="button" disabled>select</button>
	  </div><!-- close recommendation_lineup_section -->
	  <input type="hidden" name="target_username" id="target_username_input">
	  <input type="hidden" name="recommendee_username_csl" id="recommendee_username_csl_input">
</form>
<div class="ui-dialog-buttonpane">
		<div class="ui-dialog-buttonset">
			<button type='button' onclick="$('#recommendation_create_modal').dialog('close');" class="ui-button" ><span class="ui-button-text">Cancel</span></button> 
			<button class="ui-button site_dialog_button" id="create_setup" disabled><span class="ui-button-text" >Create Set-up & Notify Friend</span></button> 
		</div>
	</div><!-- close off button_bar -->

	
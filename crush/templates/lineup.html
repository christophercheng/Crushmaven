{% load fbdater_extras %}
    		<!-- Include the plugin *after* the jQuery library -->
<!--<script src="{{ STATIC_URL }}basic-slider/bjqs-1.3.js"></script>-->
<!-- Include the basic styles -->
<!--<link type="text/css" rel="Stylesheet" href="{{ STATIC_URL }}basic-slider/bjqs.css" />-->



<div id="dialog_attraction_add" title="Attraction Confirmation ">
	<input type="checkbox" checked="true">By clicking submit, you agree to all <a href="/help_terms" target="_blank">terms & conditions</a></input>
</div>
<div id="dialog_platonic_add" title="Not Interested Confirmation">
	<span id="platonic_add_text">Please tell us how you would rate their attractiveness to a friend of yours?</span><BR>
	<input type="radio" name="rating" value="1">{{rating1}}</input><BR>
	<input type="radio" name="rating" value="2">{{rating2}}</input><BR>
	<input type="radio" name="rating" value="3" checked="checked">{{rating3}}</input><BR>
	<input type="radio" name="rating" value="4">{{rating4}}</input><BR>
	<input type="radio" name="rating" value="5">{{rating5}}</input><BR>
</div>
<div id="credit_check_modal" title="Premium Feature Purchase"></div>

<!--  
<h2>Lineup for secret admirer id: {{admirer_rel.admirer_display_id}} ({{admirer_rel.source_person.first_name}} {{admirer_rel.source_person.last_name}})</h2>
 -->
<div id="lineup_container">
<div id="lineup-header">
One of these line-up members is your secret admirer!  Add any as a crush, and we'll let you know if the feeling is mutual.  All added crushes are
kept anonymous. They receive a lineup - with you in it!
</div>
 <div id="bx-pager">
 
{% for member in member_set %}

	{% if member.decision != None or forloop.counter0 == 0 %}
		<a data-slide-index="{{forloop.counter0}}" href=""><img src="http://graph.facebook.com/{{member.username}}/picture?type=large" width="50px" height="50px" /></a>
	{% else %}
			<img lineup_position={{forloop.counter0}} title="you cannot jump ahead in the lineup" src="http://a3.twimg.com/profile_images/1649076583/facebook-profile-picture-no-pic-avatar_reasonably_small.jpg" width="50px" height="50px" />
	{% endif %}
{% endfor %}
</div>  <!--  close off bx-pager div -->
<!-- Just a shell for the slideshow container -->

<ul class="bxslider" style="display:none">
{% for member in member_set %}
	{% if member.decision != None %}
		
	<li id="preload" lineup_position = {{member.position}} style="height:230px">
	
	 <div id="name">{{member.user.first_name}} {{member.user.last_name}}</div>
   <div id="mugshot" style="width:80px;height:80px"><img src="{{member.user.get_facebook_picture}}" height="80" width="10"/></div>
   <div id="position_info"><span>member {{forloop.counter}} out of {{member_set.count}}<span></div>
   <div id="facebook_link"><a href="http://www.facebook.com/{{member.username}}" target="_blank">view facebook profile</a></div>
   <div id="decision" username="{{member.username}}">
		{% if member.decision == 0 %}

       <div id="choice" class="crush">You added {{member.user.first_name}} {{member.user.last_name}} as a crush!</div>
		{% else %}
       <div id="choice">You added {{member.user.first_name}} {{member.user.last_name}} as a platonic friend.</div>
    {% endif %}
    </div> <!--   close off decision tag -->
	{% else %}	
	<li id="lineup" lineup_position="{{member.position}}" style="height:230px">
	{% endif %}
</li>

{% endfor %}
</ul>
</div>  <!--  close off lineup_container -->

<div id="lineup-footer">
<div id="footer-msg"></div>
<button id="finish-btn" type="button" disabled>Finish</button>
</div>

<script type="text/javascript">
$(document).ready(function() // handling for the slider
{ 

	/** PROCEDURAL CODE - CREATE IS_LINEUP_PAID GLOBAL
	* create global bool variable for lineup's is_lineup_paid setting
	*/
	window.is_lineup_paid = '{{admirer_rel.is_lineup_paid}}';
	if (window.is_lineup_paid == 'True')
		window.is_lineup_paid=true;
	else
		window.is_lineup_paid=false;
		
			
	/** FUNCTION - PROCESS COMPLETED LINEUP
  * enable finish button and add footer summary message
	*/
	var process_completed_lineup = function(){
		footer_element=$('#lineup_modal #lineup-footer');
		footer_element.children('#finish-btn').removeAttr('disabled');
	  footer_msg_element = footer_element.children('#footer-msg');
	  footer_msg_element_html='<b>Your Crush Lineup evaluation is complete!</b>'
	 	crush_li_elements = $('.bxslider li#preload').has('#decision .crush');
	 	total_crushes=crush_li_elements.length;
	 	if (total_crushes > 0){ 
	 		footer_msg_element_html += '<BR> <b>Added to crush list (' + total_crushes + '):</b>';
		  crush_li_elements.each(function(index,item){
				footer_msg_element_html += ' ' +$(item).children('#name').html();
				if (index < (total_crushes - 1))
					footer_msg_element_html += ',';	
		  });
		}
		footer_msg_element.html(footer_msg_element_html);
	};
	
	/** FUNCTION - UPDATE FOOTER MESSAGE
  * called everytime a slide load is completed
	*/
		var updateFooterMsg = function(){
		footer_msg_element=$('#lineup_modal #lineup-footer #footer-msg');
		// number of evaluated members
		var decided_li_elements = $('.bxslider li#preload #decision #choice');	
	 	var total_decisions=decided_li_elements.length;
		// total members
		var total_members="{{member_set.count}}";
	  footer_msg_element.html('<div id="progressing">evaluated ' + total_decisions + ' of ' + total_members + ' members</div>');
	};
		
	/** FUNCTION - LAUNCH SLIDER
	*Launch the slider at a parameterized position
	*/
	var launch_slider_at = function(last_loaded_slide){
		window.slider_control = $('.bxslider').bxSlider({
			pagerCustom: '#bx-pager',
			infiniteLoop: false,
			hideControlOnEnd: false,
			speed:800,
			adaptiveHeight:true,
			startSlide: 0,
			slideSelector:'li#preload',
			onLastSlideNext: window.handleLastSlideNext
			});
		$('#lineup_container').find('.bxslider').show();
		console.log($('#lineup_container').find('.bxslider'));
		setTimeout(function(){window.slider_control.goToSlide(last_loaded_slide)},500);
		updateFooterMsg();
	};	
		
	/** FUNCTION - AJAX LOAD NEXT SLIDE
	* Ajax load the next slide into the DOM
	*/	
	var load_next_slide = function(next_position, callback){
		var load_url = '/ajax_get_lineup_slide/{{admirer_rel.admirer_display_id}}/' + next_position + '/';
		$('.bxslider li[lineup_position=' + next_position + ']').load(load_url, function(responseText, textStatus, xhr) {
			if (textStatus!='success'){
				if (xhr.status==405){
					reauthorize_user();
					return;
				}
				$(this).dialog("close");
				window.alert_user("{{ajax_error}}");
				return false;
			}
			// load the next thumbnail as well
			var next_username =$(this).find('#decision').attr("username");
			var new_src = 'http://graph.facebook.com/' + next_username + '/picture?type=large';
			var img_element = $('#bx-pager img[lineup_position=' + next_position + ']')

			img_element.attr('src', new_src).attr('width','50').attr('height','50');	
			img_element.wrap('<a data-slide-index="' + next_position + '" href="">');
			callback(next_position);
				// add the fake next button if we're not at the last slide
			}).attr("id", "preload"); // close off ajax load of next slide
	}; // close off of helper function: load_next_slide
	
	/** FUNCTION - RESET SLIDER
	* reset the slider (if # slides changed) and advance it to last slide 
	*/
	var resetAndAdvanceSlider = function(just_loaded_slide){
		window.slider_control.reInitialize();						
		setTimeout(function(){
			window.slider_control.goToSlide(just_loaded_slide);
		},1000);
	}; // close off resetAndAdvanceSlider
	
	/** FUNCTION - HANDLE ADD ATTRACTION CLICK
	* handle click to 'add member' as crush or platonic friend
	*/
	$("#dialog_attraction_add").dialog({modal: true, autoOpen: false});
  $('#lineup_container li').on('click','a.attraction_add',function(e) {
		var parent = $(this).parent();				//# decision div
	  var url;
	  var bIsCrush=true;
	  // obtain position of the next slide in deck for future loading
		var current_position = parent.parent().attr('lineup_position'); // e.g. 3 
		var next_position = parseInt(current_position) + 1;
		next_position=next_position.toString(); 
		url="/ajax_add_lineup_member/crush/{{admirer_rel.admirer_display_id}}/" +  $(this).attr('username') + "/"; 

	  e.preventDefault();
	  $("#dialog_attraction_add").dialog('option', 'buttons', {
				"Cancel": function() {$(this).dialog("close");
				}, // end of cancel handler
				"Submit": function() {
				if ($(this).children('input:checked').length == 0){
					window.alert_user("You must agree to the terms and conditions before continuing.");
					return;
				}
				parent.load(url, function(responseText,textStatus,XHR){
					if (textStatus!='success'){
						window.alert_user("{{ajax_error}}");
						return false;
					};
					$("#num_crushes_in_progress").load("/ajax_update_num_crushes_in_progress/");
					if (next_position < {{member_set.count}})	{
						updateFooterMsg();
						// if the slide that was just decided on was the second one and is_lineup_paid=false, then auto launch the check dialog 
						if (current_position == 0 && !window.is_lineup_paid && {{member_set.count}} > 1)
							setTimeout(window.launch_credit_check,1000);
						else 
							load_next_slide(next_position, resetAndAdvanceSlider);	
						} // close off - if not at last slide
					else // enable finish button
						process_completed_lineup();
					}); // close off parent.load (making the decision and showing the html results		
					$(this).dialog("close");
				}   // end of add handler
			}); // end of .dialog handler
    $("#dialog_attraction_add").dialog("open");
    return false;
	}); // end of click handler: $('#lineup_container li').on('click','a.attraction_add',function(e)
	
	/** FUNCTION - HANDLE ADD PLATONIC CLICK
	* handle click to 'add member' as crush or platonic friend
	*/
	$("#dialog_platonic_add").dialog({modal: true, autoOpen: false});
  $('#lineup_container li').on('click','a.platonic_add',function(e) {
		var parent = $(this).parent();				//# decision div
	  var url;
	  // obtain position of the next slide in deck for future loading
		var current_position = parent.parent().attr('lineup_position'); // e.g. 3 
		var next_position = parseInt(current_position) + 1;
		next_position=next_position.toString();
		url="/ajax_add_lineup_member/platonic/{{admirer_rel.admirer_display_id}}/" + $(this).attr('username') + "/"; 
	  e.preventDefault();
	  $("#dialog_platonic_add").dialog('option', 'buttons', {
			"Cancel": function() {$(this).dialog("close");
				}, // end of cancel handler
			"Submit": function() { 
			
				var rating = $('#dialog_platonic_add input:checked').val();
				url += rating + "/";
				parent.load(url,function(responseText,textStatus,XHR){
					if (textStatus!='success'){
						window.alert_user("{{ajax_error}}");
						return false;
					};
						$("#num_platonic_friends").load("/ajax_update_num_platonic_friends/");   				
					if (next_position < {{member_set.count}})	{
						updateFooterMsg();
						// if the slide that was just decided on was the second one and is_lineup_paid=false, then auto launch the check dialog 
						if (current_position == 0 && !window.is_lineup_paid && {{member_set.count}} > 1)
							setTimeout(window.launch_credit_check,1000);
						else 
							load_next_slide(next_position, resetAndAdvanceSlider);	
						} // close off - if not at last slide
					else // enable finish button
						process_completed_lineup();
					}); // close off parent.load (making the decision and showing the html results		
					$(this).dialog("close");
					// reset the dialog's checked radio button
					$('#dialog_platonic_add input:radio[value=3]').attr('checked',true);
				}   // end of add handler
			}); // end of .dialog handler
    $("#dialog_platonic_add").dialog("open");
    return false;
	}); // end of click handler: $('#lineup_container li').on('click','a.platonic_add',function(e)
	
	
	/** FUNCTION - HANDLE SLIDER LAST NEXT CLICK
	* callback handler for slider called when last next button is clicked
	*   checks to see if check-payment dialog should be launched (on second slide if lineup_paid is false)
	*/
	window.handleLastSlideNext = function(activeSlideElement,activeIndex){
		// if active slide is last slide (which is 1) and no decision has been made yet, then launch credit check
		if (activeIndex == 0 && activeSlideElement.has('#choice').length && !window.is_lineup_paid){
			window.launch_credit_check();
		}
		else {		
			if (activeIndex+1 < {{member_set.count}}){ 
				var member_name = activeSlideElement.children('#name').html();
				window.alert_user("Sorry, you can not jump ahead without making a decision on " + member_name);
			}
		}
	};
	
	/** PROCEDURAL CODE
	* Preload any slides that already have a decision
	*/

	var last_loaded_slide = $('.bxslider li#preload').length - 1;
	//var last_loaded_slide=-1;
	//$('.bxslider li#preload').each(function(index){
	//		$(this).load('/ajax_get_lineup_slide/{{admirer_rel.admirer_display_id}}/' + index + '/');	
	//		last_loaded_slide = index;
	//});

	/** PROCEDURAL CODE
	* possibly load the next upcoming slide if we are at first position or if lineup is already paid
	* then call the slider launching function
	*/
	var next_loaded_slide=last_loaded_slide+1;
	if (next_loaded_slide < {{member_set.count}}) { // we haven't decided on last member yet
		if (last_loaded_slide<0 || window.is_lineup_paid ) 	// we've only loaded 0 or 1 slide or lineup already paid, so load next automatically
				load_next_slide(next_loaded_slide,launch_slider_at);
		else // don't load slide after last, just open slider at last loaded position
				launch_slider_at(last_loaded_slide);		
	} // lineup isn't paid so just open slider with whatever was already decided
	else{
		launch_slider_at(0);
		process_completed_lineup(); // if lineup is finished then just process it
	}

	/** FUNCTION - LAUNCH CREDIT CHECK DIALOG
	* 
	*/
 	$("#credit_check_modal").dialog({modal: true,resizable:false, autoOpen: false});    
	
	window.launch_credit_check = function() {

		var success_path='/admirers/{{admirer_rel.admirer_display_id}}/';
		var cancel_url='http://{{request.get_host}}/admirers/{{admirer_rel.admirer_display_id}}';
		var feature_id = '1';
  	if(cancel_url.substr(-1) == '/')  // return from paypal adds an extra trailing slash to cancel_url, so make sure it doesn't already have one
   		cancel_url = cancel_url.substr(0, cancel_url.length - 1);
   	load_url="/credit_checker/" + feature_id + "/{{admirer_rel.admirer_display_id}}/?success_path=" + success_path + "&cancel_url=" + cancel_url;
		$("#credit_check_modal").html('<div id="site-loading"></div>');
		$("#credit_check_modal").load(load_url,function(responseTxt,statusTxt,xhr){
				if (statusTxt!="success"){
					$(this).html("{{ajax_error}}");
			    $("#site-loading").remove();
			   }
		}); 
		$("#credit_check_modal").dialog("open");
		return false;
   }; // close off window.launch_credit_check function
   
	
	/** FUNCTION - HANDLE CREDICT CHECK OK-TO-DEDUCT CLICK
	* click handler for credit checker dialog - when ok-to-deduct is clicked
	*   calls ajax_deduct_credit so that server deducts credit and re-adjusts is_lineup_paid
	*   after successful return from ajax call, updates global is_lineup_paid and advances lineup
	*/
	 $('#credit_check_modal').on('click','#credit_deduct_ok',function(e) {

		// call ajax post function to deduct credit and change lineup_is_paid to true 
	 	$("#site-overlay").css('visibility','visible');

		var post_dict = {"csrfmiddlewaretoken":"{{csrf_token}}"};
		var post_url = '/ajax_deduct_credit/1/{{admirer_rel.admirer_display_id}}/' // feature is type 2
		$.post(post_url,post_dict,function(data) {
			// if successful then load next slide and thumbnail and auto go to that slide
			$('#site-overlay').css('visibility','hidden');
			$('#num_new_admirers').load('/ajax_update_num_new_admirers');
			next_position=parseInt(window.slider_control.getCurrentSlide()) + 1;
			load_next_slide(next_position,resetAndAdvanceSlider);
			window.is_lineup_paid=true;
			// adjust the credits number on the main site
			$("#num_credits").load("/ajax_update_num_credits/");
			}) 
			.fail(function(){// if fail (credit was suddenly not available or network problem), then do nothing
					window.alert_user("{{ajax_error}}");
					$('#site-overlay').css('visibility','hidden');
			}); // end of $.post(post_url...)
		}); // close off credit_check handler - $('#credit_check_modal').on('click','#credit_deduct_ok',function(e)

	/** FUNCTION - HANDLE FINISH BTN CLICK
  *
	*/
	// need to also handle a.ui-dialog-titlebar-close"
	var handle_lineup_dialog_close = function(){
		var current_href=document.location.href;
		var decided_li_elements = $('.bxslider li#preload #decision #choice');	
	 	var total_decisions=decided_li_elements.length;
		$('#lineup_modal').dialog("close");
		if (current_href.indexOf("/admirers/") != -1) { // if user is on progressing admirers page, not on completed admirers page:
			// redirect user to crushes in progress if there is only one progressing lineup and it is done
				if (total_decisions == {{member_set.count}} && {{ request.user.get_progressing_admirers.count }} == 1)	
					document.location.href='/attractions/';
				else
					location.reload();
		}
	};
	
	
	$('.ui-dialog').on('click','a.ui-dialog-titlebar-close',function(e) {
		handle_lineup_dialog_close();
	});
	
	$('#lineup_modal').on('click','#finish-btn',function(e) {
		handle_lineup_dialog_close();
	});

}); // close off jquery document ready

</script>



{% extends "base.html" %}
{% block content %}

{% load fbdater_extras %}


<div id="credit_check_modal" title="Premium Feature Purchase"></div>

<div id="lineup_modal" title="Secret Admirer Lineup"></div>

<script type="text/javascript">

$(document).ready(function() 
{
	
        $("#credit_check_modal").dialog({modal: true, autoOpen: false});
        $("#lineup_modal").dialog({modal: true, resizable:false,autoOpen: false,height:500,width:640});
				$('.lineup').on('click', '.check_credit', function(e) {
					credit_check_element=$(this);
        	var success_path=credit_check_element.attr('success_path');	
        	var cancel_url = credit_check_element.attr('cancel_url');
        	// return from paypal adds an extra trailing slash to cancel_url, so make sure it doesn't already have one
        	if(cancel_url.substr(-1) == '/') 
        		cancel_url = cancel_url.substr(0, cancel_url.length - 1);
        	var feature_id=credit_check_element.attr('feature_id');
        	load_url="/credit_checker/" + feature_id + "/?success_path=" + success_path + "&cancel_url=" + cancel_url;
            e.preventDefault();
					$("#credit_check_modal").load(load_url);   	
           $("#credit_check_modal").dialog("open");
                     $(".ui-widget-overlay").css("background","black").css("opacity",".5");
            return false;
            
        });
        
        $('.lineup').on('click', '.view_lineup', function(e) {
					view_lineup_element=$(this);
        	var display_id=view_lineup_element.attr('display_id');	
        	load_url="/ajax_show_lineup_slider/" + display_id + "/";
          e.preventDefault();
					$("#lineup_modal").load(load_url);   	
          $("#lineup_modal").dialog("open");
          $(".ui-widget-overlay").css("background","black").css("opacity",".80");
          return false;
            
        });
        
        
 

				
});
</script>

<!-- Display the crush type navigation widget -->  
<HR>
<font color="gray">
{% if admirer_type = 0 %}
<b>Secret Admirers ({{admirer_relationships.count}})</b>&nbsp;&nbsp;<a href="/admirers_past">Past Admirers ({{past_admirers_count}})</a>
{% else %}
<a href="/admirers">Secret Admirers ({{progressing_admirers_count}})</a><b>&nbsp;&nbsp;Past Admirers ({{admirer_relationships.count}})</b>
{% endif %}
</font>
<BR><BR>
  
<!-- End of crush type navigation widget -->  

{% if admirer_relationships %}
<script>
var lineups_need_initialization=false;
var show_lineup_number = '{{request.GET.show_lineup}}';
</script>
	<ul>
		{% for admirer_rel in admirer_relationships %}
			<li> Secret Admirer #{{admirer_rel.admirer_display_id}} 
			({% if admirer_rel.friendship_type == 0 %} friend of yours {% elif admirer_rel.friendship_type == 1 %}friend-of-a-friend{% endif %})

			<BR>(added {{admirer_rel.date_added|datetime_since}} ago) <BR> 
			<div id="{{admirer_rel.admirer_display_id}}" class="lineup">
      <script>
      	$(".lineup#{{admirer_rel.admirer_display_id}}").load('/ajax_display_lineup_block/{{admirer_rel.admirer_display_id}}',function(){
    				 // if there is a show_lineup get variable, and it is equal to the current admirer's display_id, then auto show this lineup
    				 if (show_lineup_number && show_lineup_number=={{admirer_rel.admirer_display_id}})
    						 $(this).children('.view_lineup').trigger('click'); 		
      	});           
      </script>          
     	<!-- 
                <script>
                {% if admirer_rel.is_lineup_initialized %}
                	$(".lineup#{{admirer_rel.admirer_display_id}}").load('/ajax_display_lineup_block/{{admirer_rel.admirer_display_id}}').error(function(e){alert("fail");});           
                {% else %}
                    lineups_need_initialization=true;
                 {% endif %}
                 </script>
                  -->
                 <div id="admirer-loading"></div>
			</div>

			<BR><BR>
		{% endfor %}

	<script type="text/javascript">
        if (lineups_need_initialization) {
        $.get('/ajax_are_lineups_initialized',function() 
                                {   
                                    $(".lineup").has("script").each(function(index){
                                        $(this).load('/ajax_display_lineup_block/' + this.id);
                                        });
                                 });
        /*
            check_lineups = function() 
                {   
                    setTimeout(function()
                        {
                            $.get('/ajax_are_lineups_initialized',function() 
                                {   
                                    $(".lineup").has("script").each(function(index){
                                        $(this).load('/ajax_display_lineup_block/' + this.id);
                                        }); // close off each loop
                                 }).error(check_lineups); // close off get and add error callback
                         },1000); // close off setTimeout         
                }; // closeoff check_lineups
            check_lineups(); // make first call to check lineups
        */
        
        } // close of if conditional block    
	</script>

	</ul>
{% else %}
	THERE ARE NO {% if admirer_type = 0 %} CURRENT {% else %} PAST {% endif %} SECRET ADMIRERS!
{% endif %}


{% endblock %}
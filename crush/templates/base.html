<!DOCTYPE html>
<html lang="en">
    <head>
	    <meta http-equiv="Content-type" content="text/html"; charset="UTF-8" />
	    <meta name="description" content="When you already have someone in mind, but not sure they feel the same... Discover your relationship potential - safely and anonymously." />
	    <meta name="robots" content="all,index" />
	    <meta name="Revisit-After" content="30 Days" />
	    <meta http-equiv="X-UA-Compatible" content="IE=edge" /> <!-- ie8 - ignore compatibility option-->
		<title>JustMaybe.us - {% block title %}{% endblock %}</title>    	
	    {% block extrahead %}{% endblock %}

        <link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/themes/base/jquery-ui.css">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
        <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>
        
        <link type="text/css" href="{{ STATIC_URL }}friend-selector/jquery.friend.selector-1.2.css" rel="stylesheet" />
		<script type="text/javascript" src="{{ STATIC_URL }}friend-selector/jquery.friend.selector-1.2.js"></script>

        <link rel="stylesheet" href="{{ STATIC_URL }}contactable/contactable_sw.css" type="text/css" />
		<script type="text/javascript" src="{{ STATIC_URL }}contactable/jquery.contactable_sw.js"></script>

		<script src="{{ STATIC_URL }}credit_check_dialog.js"></script>

		<link type="text/css" href="{{ STATIC_URL }}fbdater.css?t={% now "U" %}" rel="stylesheet"  />
    </head>
<body>
<!-- INITIALIZE FB JS INTEGRATION -->
<div id="fb-root"></div> 
<script>
	window.fbAsyncInit = function() {
	  FB.init({ 
	  	appId: {{facebook_app_id}}, 
	  	status: true, 
	  	cookie: true,
	  	xfbml: true,
	  	oauth: true,
	  });
  	  	// Additional init code here
	};
  // Load the SDK Asynchronously
  (function(d){
     var js, id = 'facebook-jssdk', ref = d.getElementsByTagName('script')[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement('script'); js.id = id; js.async = true;
     js.src = "//connect.facebook.net/en_US/all.js";
     ref.parentNode.insertBefore(js, ref);
   }(document));

	function login(connect_callback) {
    FB.login(function(response) {
        if (response.authResponse) {
        		if (connect_callback)
        			connect_callback();
            // connected
        } else {
            // cancelled

        }
    });
	}
</script>

<!-- INITIALIZE ATTRACTION SELECTOR DIALOG -->   
<script> 
jQuery(document).ready(function($) {


	 /* ---------------------------------------------
	 	
	 		APP INVITE MODAL
	 	
	 * -------------------------------------------- */

		window.app_invite_modal=null;
		$(".app_invite_link,#invite_interstitial_modal").on("click", ".app_invite", function(e) {
			e.preventDefault();
			// only initialize jquery modal dialog once per page load

			if (!window.app_invite_modal)
				window.app_invite_modal = $("#app_invite_modal").dialog({dialogClass:"app_invite_dialog",resizable:false, modal: true, autoOpen: false,position:{my:"left center",at:"right+33 center-90",of:'.left_sidebar_container .bt-fs-dialog'}});
			window.app_invite_modal.html('<div id="site-loading"></div>');
			window.app_invite_modal.dialog('open');
			var crush_username=$(this).attr('crush_username');	
			var crush_fullname=$(this).attr('crush_fullname');
			var load_url="/app_invite_form_v2/" + crush_username + "/" + encodeURIComponent(crush_fullname) + "/";
			window.app_invite_modal.load(load_url,function(responseText,textStatus,XHR){
				if (textStatus!="success"){
					if (!window.access_token_error(responseText))
						$(this).html("{{ajax_error}}");
				}
			});	
		});	
	
	//-------------  App Invite Interstitial ------------------
	// launch interstitial
	//
	//		inputs:
	//			json of attractions: attraction_username = attraction_full_name
	//			redirect page (where to go after dialog closes) 
	//		functionality:
	//			dynamically build dialog html elements based off of the inputted array
	
	window.invite_interstitial_modal=null;
	window.invite_interstitial_modal_redirect_url="";
	window.launch_invite_interstitial = function(attraction_json,redirect_url) {
			// only initialize jquery modal dialog once per page load
			
			if (!window.invite_insterstitial_modal)
				window.invite_interstitial_modal = $("#invite_interstitial_modal").dialog({dialogClass:"invite_interstitial_dialog",resizable:false, width: '450px',modal: true, close: function(){location.href=redirect_url;},autoOpen: false});
			else
				window.invite_interstitial_modal.dialog({close: function(){if (redirect_url!="") location.href=redirect_url;}})
			var modal_html ="";
			modal_html += '<div class="modal_instructions">To get a response from your newly added attraction(s), please help us get them signed into the application.</div>';
			modal_html += '<div class="modal_main_content">';
			window.invite_interstitial_modal.dialog('open');	
			
			var counter = 0;
			for (var username in attraction_json) {
				counter++;
				if (counter == 1)
					modal_html += '<div class="attraction_invite_row first_row">';
				else
					modal_html += '<div class="attraction_invite_row">';
					// picture
					modal_html +='<img src="http://graph.facebook.com/' + username + '/picture?width=30&height=30">';
					// full name
					modal_html +='<span class="attraction_invite_full_name">' + attraction_json[username] + '</span>';
					// invite button (or invite sent text)
					modal_html +='<div class="attraction_invite_button" username="' + username + '"><button class="app_invite" crush_username="' + username + '" crush_fullname="' + attraction_json[username] + '">send anonymous invite</button></div>';
				modal_html += '</div>'; //close off attraction_invite_row div
			}
				
			modal_html += '</div>';//close off dialog_main_content div
			window.invite_interstitial_modal.html(modal_html);
			window.invite_interstitial_modal.dialog("option","position","center");
	};
	
	
	// input: attraction: username represents the attraction that was just invited  
	// functionality: auto redirect to inputted redirect page if all attraction invites sent
	//	 		if redirect page is same as current page, just close dialog
	//	 		if at least one attraction invite not sent, then
	//			replace button of newly invited attraction with 'invite(s) sent' 
	window.update_invite_interstitial = function(attraction_username){
		if (!window.invite_interstitial_modal || !window.invite_interstitial_modal.dialog( "isOpen" ))
			return false;
		if (window.app_invite_modal)
			window.app_invite_modal.dialog('close');
		 // search for the associated button and update it's html
		target_element = $('#invite_interstitial_modal .modal_main_content .attraction_invite_row .attraction_invite_button[username=' + attraction_username + ']');
		console.log(target_element);
		target_element.html('invite(s) sent');
		
		// if no buttons exist, then auto close the dialog and redirect it 
		if ($('.attraction_invite_button button').length == 0)
			window.invite_interstitial_modal.dialog("close");
	}	
	
  $(".bt-fs-dialog").fSelector({ // call the .fSelector function and send it a massive dictionary of option values
	  accessToken: "{{request.user.access_token}}",
	  facebookID: "{{request.user.username}}",
	  malePref:null,// {% if request.user.gender_pref = 'F' %} false {% elif request.user.gender_pref = 'M' %} true {% else %} null{% endif %},
    maleGender: {% if request.user.gender = 'F' %} false {% elif request.user.gender_pref = 'M' %} true {% else %} null{% endif %},
    minimum_samegender_friends:"0",//"{{minimum_samegender_friends}}",
    minimum_crushgender_friends:"0",//"{{minimum_crushgender_friends}}",
    max:12,
	  excludeIds: "{% for crush_rel in request.user.crush_crushrelationship_set_from_source.all %}{{crush_rel.target_person.username}}{% if not forloop.last %},{% endif %}{% endfor %}",
    closeOverlayClick: false,
    overlayOpacity: "0.5",
    overlayColor: '#000',
    closeOnSubmit: true,
    showSelectedCount: true,
    color: "default",
    showRandom:false,
    lang: {
      title: "Add Crushes",
      searchText: "Enter a friend's name",
      fbConnectError: "You must be logged in to Facebook in order to use this feature.",
      selectedCountResult: "You have choosen {0} people.",
      selectedLimitResult: "Limit is {0} people.",
      ajaxError:"{{ajax_error}}",
    },
    onSubmit: function(response){
			add_friends_to_db(response);
    },
    onError: function(){
    	window.alert_user("{{ajax_error}}");
    },
    onStart: function(){
    	 $("#fs-dialog-box-wrap").draggable({handle:"#fs-dialog-title"});
    	 window.scrollTo(0,0); // hack to allow dialog to show - cause it always loads relative to fixed elements
    	 //$('body').css('overflow-y','hidden !important');
    },
    });

  function add_friends_to_db(response)
  //response is a json object of username:fullname with username having extra character at end representing friendship type
  {	      
		var result_dictionary = {};
		var attraction_invites_json={};
		result_dictionary["csrfmiddlewaretoken"]="{{csrf_token}}";
		for (attraction in response){
			result_dictionary[attraction.slice(0,-1)]=attraction.slice(-1);
			attraction_invites_json[attraction.slice(0,-1)]=response[attraction];
		};
  	$.post('/ajax_add_crush_targets/',result_dictionary, function(){
  		// on success redirect to the crush page
  		window.launch_invite_interstitial(attraction_invites_json,'/attractions'); 
  		//document.location.href='/attractions/'; // reload page
  	}).fail(function(error){window.alert_user(error.responseText);});
  };

}); // close of jQuery(document).ready
</script>

<!-- AJAX CALL INITIALIZATION -->
<script>
// default to 15 seconds for all ajax calls: (lineup initialization will require longer wait time)
$.ajaxSetup({timeout: '45000'});
</script>

<!-- INITIALIZE SITE-WIDE MESSAGE ALERT DIALOG -->
<script>
jQuery(document).ready(function($) {
  $("#alert_modal").dialog({dialogClass:'alert_modal_dialog',resizable:false, modal: true, autoOpen: false,zIndex:999999});
 
  window.alert_user=function(message){
    $("#alert_modal").html(message);
    $("#alert_modal").dialog('option','buttons',{
  		"Ok": function() {$(this).dialog("close");
  		}
  	});
		$('#alert_modal').dialog("open");
		$('#alert_modal').dialog("moveToTop");
  };  
  
  window.access_token_error=function(responseText){
		if (responseText.indexOf("HTTPError") != -1){
		  reauthorize_user();
			return true;
		}
		else 
			return false;
	};

	var reauthorize_user=function(){
		window.alert_user("For your security, we must periodically re-confirm your Facebook identity.  Our apologies for the inconvenience.");
		setTimeout(function(){location.href="/facebook/login"},1000);
	};
	
	var send_fb_invite = function(recipient_id,crush_name){
  	FB.ui({method: 'send',
  				name: crush_name + " was added as an 'attraction' by one of our users",
  				to: recipient_id,
  				link:'http://www.attractedto.com',
  				description:'AttractedTo.com is a new matchmaking service for people who already have someone (they know) in mind.'
      },
      function(response){
         // regardless of whether user cancels or sends message, reload the appropriate attraction page
         if (response != null){
				  	$(".inactive_crushed_friends").load('/ajax_friends_with_admirers_content/' + recipient_id,function(responseText,textStatus,xhr){
  					if (xhr.status==405)
  						reauthorize_user();
  				});
  			} 
      }      
    );// close off fb.ui
  }; // close off send_fb_message
   
  $(".inactive_crushed_friends").on('click', '#send_fb_invite', function(){
           var crush_id = $(this).attr('crush_username');
           var crush_name = $(this).attr('crush_name');
           send_fb_invite(crush_id,crush_name);
  });
  
// QUERY INACTIVE FRIENDS WITH ADMIRERS
  $(".inactive_crushed_friends").load('/ajax_friends_with_admirers_content/',function(responseText,textStatus,xhr){
  	if (xhr.status==405)
  			reauthorize_user();
  }); 
// INITIALIZE FEEDBACK FORM 
 $(function(){$('#contactable').contactable({csrf_token: '{{csrf_token}}'});});

// -------------  CSS additions ------------------
// HANDLE SETTINGS MENU CLICK
function openSubMenu() {
	clearTimeout(window.submenu_toggle);
	var show_me = $(this).find('ul');
	window.submenu_show=setTimeout(function(){
		if (show_me.parent().is(":hover"))
			show_me.show(100);
	},300); 
};
function closeSubMenu() {
	clearTimeout(window.submenu_toggle);
	var hide_me = $(this).find('ul');
	window.submenu_toggle=setTimeout(function(){$(hide_me).hide(300);},400);
};
$('.drop_down_menu_link > li.submenu').hover(openSubMenu,closeSubMenu);
$('#center_header_menu > li.submenu').hover(function(){$('#get_started_link').css('color','white');$(this).find('ul').show()},function(){$('#get_started_link').css('color','#DC143C');$(this).find('ul').delay(3000).hide()});
// HANDLE TITLE BAR OPTIONS SUBMENU CLICK
$('.title_bar_option a').bind('click',function(){
	$(this).parent().children('ul').toggle();
});

	
// auto close any popups when clicking elsewhere
$('body').bind('click',function(){
	$('.popup').hide();
});
$('body').on('click',".popup_link",function(e){
  e.stopPropagation();
});

//$('a.bt-fs-dialog').hover(function(){$(this).delay(40).animate({top:'+=3',left:'+=3'},100);},function(event){event.stopPropagation();$(this).animate({top:'-=3',left:'-=3'},50);});
//$('a.bt-fs-dialog').hover(function(){$(this).delay(40).animate({top:'+=2',left:'+=2',height:'-=2',width:'-=2'},10);},function(event){event.stopPropagation();$(this).animate({top:'-=2',left:'-=2',height:'+=2',width:'+=2'},50);});
//$('a.block_button').hover(function(){$(this).delay(40).animate({top:'+=2',left:'+=2'},10);},function(event){event.stopPropagation();$(this).animate({top:'-=2',left:'-=2'},50);});
 
//$('.navbar li.inactive a').hover(function(){$(this).animate({borderTopWidth:'4px',borderLeftWidth:'3px'},100);},function(event){event.stopPropagation();$(this).animate({borderTopWidth:'0px',borderLeftWidth:'0px'},100);});

 /* ---------------------------------------------
 	
 		REQUEST SETUP Handling
 	
 * -------------------------------------------- */

  $(".request_setup_link").fSelector({ // call the .fSelector function and send it a massive dictionary of option values
	  accessToken: "{{request.user.access_token}}",
	  facebookID: "{{request.user.username}}",
	  malePref:null,// {% if request.user.gender_pref = 'F' %} false {% elif request.user.gender_pref = 'M' %} true {% else %} null{% endif %},
    maleGender: {% if request.user.gender = 'F' %} false {% elif request.user.gender_pref = 'M' %} true {% else %} null{% endif %},
    minimum_samegender_friends:"0",//"{{minimum_samegender_friends}}",
    minimum_crushgender_friends:"0",//"{{minimum_crushgender_friends}}",
    max:12,
	  excludeIds: "{% for request_rel in request.user.crush_setuprequestrelationship_set_from_source.all %}{{request_rel.target_person.username}}{% if not forloop.last %},{% endif %}{% endfor %}",    
    closeOverlayClick: false,
    overlayOpacity: "0.5",
    overlayColor: '#000',
    closeOnSubmit: true,
    showSelectedCount: true,
    color: "default",
    showRandom:false,
    lang: {
    	buttonContinue:"Select",
      title: "Request Setups from Friends",
      searchText: "Enter a friend's name",
      fbConnectError: "You must be logged in to Facebook in order to use this feature.",
      selectedCountResult: "You have choosen {0} people.",
      selectedLimitResult: "Limit is {0} people.",
      ajaxError:"{{ajax_error}}",
    },
    onError: function(){
    	window.alert_user("{{ajax_error}}");
    },
    onStart: function(){
    	 $("#fs-dialog-box-wrap").draggable({handle:"#fs-dialog-title"});
    	 window.scrollTo(0,0); // hack to allow dialog to show - cause it always loads relative to fixed elements
    },
    onSubmit: function(response){
			var attraction_array = [];
			for (attraction in response)
				attraction_array.push(attraction.slice(0,-1));
			send_fb_requests(attraction_array);
    }, // close off onSubmit function handler
   }); // close off .fSelector function handler

	function send_fb_requests(attraction_array){
	    var csrf_data={};
    	csrf_data["csrfmiddlewaretoken"]="{{csrf_token}}";
		FB.ui({method: 'send',
	  				name: "{{request.user.first_name}} {{request.user.last_name}} would like your help to find potential dates.",
	  				to: attraction_array[0],
	  				link:'http://www.justmaybe.us',
	  				description:'JustMaybe.us is a new matchmaking service that makes it easy for friends to match their single friends up with one another.'
			      },
			      function(response){
							if (response != null){
								$.post('/ajax_create_setup_request/' + attraction_array[0] + '/',csrf_data, function(){
									attraction_array.splice(0,1);
									if (attraction_array.length)
										send_fb_requests(attraction_array);  	
									else // reload page so that the new requests can be processed by base.html javascript
										window.location.href="/setup_requests_by_me/";
								});
							}
							else {
								attraction_array.splice(0,1);
								if (attraction_array.length)
									send_fb_requests(attraction_array);  	
								else // reload page so that the new requests can be processed by base.html javascript
									window.location.href="/setup_requests_by_me/";
							}
			  		} // close off function (response)   
		   	 	);// close off fb.ui
	};

 /* ---------------------------------------------
 	
 		SETUP CREATION MODAL
 	
 * -------------------------------------------- */

	window.setup_create_modal=null;
	$("a.set_up_friend_link").click(function(e) {
		e.preventDefault();
		// only initialize jquery modal dialog once per page load

	//if (!window.setup_create_modal)
			window.setup_create_modal = $("#setup_create_modal").dialog({
				dialogClass:"setup_create_dialog",resizable:false, modal: true, autoOpen: false,close:function(){location.reload();},width:500,height:298});
		window.setup_create_modal.html('<div id="site-loading"></div>');
		window.setup_create_modal.dialog('open');
		var target_person_username = $(this).attr('target_person_username');
		var load_url="/setup_create_form/";
		if (target_person_username)
			load_url = load_url + target_person_username + '/';
		window.setup_create_modal.load(load_url,function(responseText,textStatus,XHR){
			if (textStatus!="success"){
				if (!window.access_token_error(responseText))
					$(this).html("{{ajax_error}}");
			}
		});	
	}); // close off .click(function(e){

// work-around solution for left menu click problem 
$('.left_sidebar_container .navbar .inactive a').mousedown(function(event)
	{
	if (event.button == 0){
		//$(this).css('border-left','1px solid #2E2E2E');
		//$(this).css('border-top','1px solid #2E2E2E');
		$(this).css('border','1px solid #2E2E2E');
		$(this).css('padding-right','6px');
	}
	});

$('.left_sidebar_container .navbar .inactive a').mouseup(function(event)
	{
		if (event.button == 0){
			$(this).css('border','none');
			$(this).css('padding-right','7px');
			location.href=$(this).attr('href');
		}
	});

function handle_window_resize(){
	$('.ui-dialog-content:visible').each(function(){
		var dialog = $(this).data("dialog");
		dialog.option("position","center");
		});
};
var timeoutPointer;
$(window).resize(function(){
	clearTimeout(timeoutPointer);
	timeoutPointer = setTimeout(handle_window_resize,100);
});

}); // close of jQuery(document).ready




</script>

<div class="header">
	<div class="header_container">{% include "navigation_top.html" %}</div>
</div><!-- close off header divs -->

<div class="main_container">
	<div class="left_sidebar">
		<div class="left_sidebar_container">{% include "navigation_left.html" %}</div>
	</div> <!-- close off left_sidebar -->
	<div class="right_sidebar">
		<div class="right_sidebar_container">{% include "navigation_right.html" %}</div>
	</div> <!-- close off right_sidebar -->
	<div class="center_panel">
		<div class="center_panel_container">
			{% block content %}
			{% endblock %}
		</div> <!-- close off center_content_container -->
	</div> <!-- close off center_panel -->
</div> <!-- close off main_container -->
<div id="site-overlay"><div id="site-loading"></div></div>
<div id="alert_modal" title="Something's Not Right"></div>
<div id="app_invite_modal" title="Send Anonymous Invites"></div>
<div id="invite_interstitial_modal" title = "One Last Thing!"></div>
<div id="credit_check_modal" title="Feature Purchase"></div>
<div id="setup_create_modal" title="Set Up a Friend"></div>
<div id="contactable"><!-- contactable html placeholder --></div>
</body>

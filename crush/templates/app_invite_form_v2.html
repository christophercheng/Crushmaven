<!-- Javascript to help the form validate via ajax without reloading entire page -->
<link rel="stylesheet" type="text/css" href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/themes/base/jquery-ui.css">
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script>
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.9.2/jquery-ui.min.js"></script>

<script>
$(document).ready(function() 
{
        var form=$("#app_invite_form");
        
        form.submit(function(e) {

                $("#sendbutton").attr('disabled','disabled');
                $("#sendbutton").attr('value','sending...');
                $("#sendwrapper").prepend('<span>Sending message, please wait... </span>');
                $("#ajaxwrapper").load(
                    form.attr('action') + ' #ajaxwrapper',
                    form.serializeArray(),
                    function(responseText, responseStatus,XHR) {
                    console.log(responseText,responseStatus,XHR);
            
         				if (responseText=="_GOOD"){
                    		if (window.invite_interstitial_modal && window.invite_interstitial_modal.dialog("isOpen"))
                           window.update_invite_interstitial("{{crush_username}}");
                				else
                					location.href='/attractions';
                			}
               				else{
               						$("#sendbutton").removeAttr('disabled')
                          $("#sendbutton").attr('value','Send')
               				}
                		});
                
               e.preventDefault();
               });// close off submit function

		window.app_invite_modal.dialog("option","position","center");

// calculate height of the preview section container

/* ---------------- PREVIEW INVITE HANDLING ---------------- */

$('#app_invite_form').on('click','#preview_invite_button',function(){
	var preview_element = $('#preview_section');
	if ( preview_element.is(':visible') ){
			
			$(this).children('.ui-button-text').html('Preview Invites');
			preview_element.slideToggle(250);
			$(this).removeClass('preview_close');
			$('.sent_from_us').fadeTo(0,0).css('left',420);
			$('#app_invite_form #sendbutton').removeAttr('disabled');
	}
	else {
		$('.sent_from_us').css('left',420);
		var form_height = $('#app_invite_form').height();
		var buttonpane_height = $('#app_invite_form .ui-dialog-buttonpane').height();
		preview_element.css('bottom',buttonpane_height + 24 + 'px');
		preview_element.height(form_height - buttonpane_height -20);
		$(this).addClass('preview_close');
		$(this).children('.ui-button-text').html('Close Preview');
		$('.email_preview_content').height(form_height - buttonpane_height - 75);
		$('.email_content_body').height(form_height - buttonpane_height - 165);
		preview_element.slideToggle(750);
		$('.sent_from_us').delay(1000).animate({opacity:1,left:"-=330"},1000);
		$('#app_invite_form #sendbutton').attr('disabled','true');
	}
});// close off #preview_invite_button

$('#app_invite_form').on('click', '.inactive_tab',function(){
$('.sent_from_us').css('opacity',0);

	$('#preview_section .active_tab').removeClass('active_tab').addClass('inactive_tab');
	$(this).removeClass('inactive_tab').addClass('active_tab')
	
	if ($(this).attr('id') == 'preview_attraction_tab'){
		$('#mf_email_preview_content').fadeOut(250)
		$('#attraction_email_preview_content').delay(250).fadeIn(500);
	}
	else{
		
		$('#attraction_email_preview_content').fadeOut(250)
		$('#mf_email_preview_content').delay(250).fadeIn(500);
	}

	$('.sent_from_us').animate({opacity:1},1);
	
});

}); // close off document ready function
</script>

<form id="app_invite_form" action="http://{{request.get_host}}{% url 'crush.views.app_invite_form_v2' crush_username %}" method="post">       
<div id="ajaxwrapper">
   <div class="modal_instructions">Enter any email addresses of your attraction.  We'll send them an <strong><i>anonymous</i></strong> invitation - <strong><i>sent from our Flirtally.com email address</i></strong>.</div>

   {% csrf_token %}


   <div class="email_field_input" id="attraction_email_input_section">
      <div class="email_input_error_section generic_email_errors" >{{ form.non_field_errors }}</div>
      <label for="id_crush_emails"><span class="crush_email_name">{{crush_firstname}}</span><img src="http://graph.facebook.com/{{crush_username}}/picture?width=30&height=30"></label> 
      <div class="fieldWrapper">
         {{ form.crush_emails }}
         <div class="email_input_error_section">{{ form.crush_emails.errors }}</div>
      		<span class="email_separator sub_label">separate multiple emails with commas</span>
      </div>
   </div><!-- close attraction_email_input -->
	
<span id="mutual_friend_input_section_subtitle"><span class="strong_subtitle">Or enlist the help of your mutual friends: </span> We'll let them know what's up and ask them to forward our invitation to your attraction - without revealing your identity!</span>
<div id="mutual_friend_input_section">
	   {% for field in form %}
	   		{% if field.label != "crush_field" %}
		   		<div class="email_field_input mf_email_field_input">	   			
							<label for="id_mutual_friend_email"><span class="mf_email_name">{{field.label}}</span>{% if field.help_text %}<img src="http://graph.facebook.com/{{field.help_text}}/picture?width=25&height=25">{% else %}<img class="other_contact_pic" src = "/static/images/fb_unknown_user_pic.jpg"> {% endif %}</label>
							<div class="fieldWrapper">
								{{ field }}
								<div class="email_input_error_section">{{field.errors}}</div>
							</div><!-- close off field wrapper -->
	      	</div> <!--  close off email_field_input -->	   			
	   		{% endif %}
	   {% endfor %}
	   
	</div> <!--  close off mutual_friend_input_section -->      


<div id="preview_section">
	<span class="preview_tab active_tab" id="preview_attraction_tab">Attraction's Invite Preview</span><span class="preview_tab inactive_tab" id="preview_mf_tab">Mutual Friend's Invite Preview</span>
	<div class="preview_body">
         <div id="attraction_email_preview_content" class="email_preview_content">
           <div class="email_header">
	           <div class="email_content_header_labels">
	                   From:<BR>
	                   To:<BR>
	                   Subject:
	           </div>
	           <div class="email_content_header_content">
	                   <span class="anonymous_email_callout"><span class="sent_from_us"><span class="sent_from_us_pointer"></span>sent from us!</span>Flirtally.com</span><BR>
	                   <span class="email_address_holder">{attraction's email address}</span><BR>
	                   <span class="subject_text">You have an admirer!</span>
	           </div>
           </div>
           <span class="email_content_body">
		<p>One of our users is attracted to you.  Sign in to Flirtally.com to find out whom. </p>
		<p><b>What is Flirtally?</b> It's a new matchmaking service for people who already have someone in mind – either for themselves or friends of theirs.  Match your friends up, or find out if someone you know and like feels the same at Flirtally.com.
		</p>				
           </span>
            </div>  <!-- close off attraction_email_preview_content -->
    <div id="mf_email_preview_content" class="email_preview_content">
        <div class="email_header">
	        <div class="email_content_header_labels">
	                From:<BR>
	                To:<BR>
	                Subject:<BR><BR>
	        </div>
	        <div class="email_content_header_content">
	                <span class="anonymous_email_callout"><span class="sent_from_us"><span class="sent_from_us_pointer"></span>sent from us!</span>Flirtally.com</span><BR>
	                <span class="email_address_holder">{mutual friend's email address}</span><BR>
	                <span class="subject_text">Your friend has an admirer!</span>
	        </div>
        </div> <!--  close off .email_header -->
        <div class="email_content_body">
        		<p>Someone at Flirtally.com is attracted to {attraction name} and would like your help to determine if they feel the same.  Unfortunately, we can't tell you more than that.  {attraction name}'s admirer wishes to remain anonymous.
        		</p>
        		<p>
        		Would you please take a second to forward this message to {attraction name}?     
        		</p>
        		<p>
        		<b>What is Flirtally?</b>  It's a new matchmaking service for people who already have someone in mind – either for themselves or friends of theirs.  Match your friends up, or find out if someone you know and like feels the same at Flirtally.com.
        		</p>
        		<p>And in case you're wondering: {attraction name}'s admirer provided us with your email address.  We won't share it with anyone else, and we'll delete it once they sign up.
        		</p>
        </div>
		</div>  <!-- close off mf_email_preview_content -->
	</div> <!--  close off preview_body_mf -->
</div> <!--  close off #preview_section -->

  <div class="ui-dialog-buttonpane">
          <div class="ui-dialog-buttonset">
          	<button type='button' class="site_dialog_button site_dialog_cancel_button preview_button" id="preview_invite_button"><span class="ui-button-text">Preview Invites</span></button>
          	<button type='button' onclick="window.app_invite_modal.dialog('close');" class="site_dialog_button site_dialog_cancel_button" ><span class="ui-button-text">Cancel</span></button> 
          	<input id="sendbutton" class="site_dialog_button" type="submit" value="Send"/>
          </div><!-- close off buttonset -->
  </div><!-- close off buttonpane -->
	<input type="hidden" name="mutual_friend_json" value="{{mutual_friend_json}}">
	<input type="hidden" name="posted_form" value="">
	<input type="hidden" name="crush_fullname" value = "{{crush_fullname}}">
</div><!-- close off ajaxwrapper -->
</form>
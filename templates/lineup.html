{% load fbdater_extras %}
<div id="dialog_attraction_add" title="Attraction Confirmation "></div>
<div id="dialog_platonic_add" title="Not Interested Confirmation"></div>
<link href="{{ CDN_URL }}bxSlider/jquery.bxslider.css" rel="stylesheet" />
<script src="{{ CDN_URL }}bxSlider/jquery.bxslider.js"></script>

<div id="lineup_container">
<div id="lineup-header">
	{% if is_admirer_type == 1 %}
		One of these line-up members is your admirer!  Add any as an attraction, and we'll notify you if we determine the feeling is mutual.  If not, your identity remains protected.  Your attractions receive a similar lineup - with you in it!
	{% else %}
		Your friend recommended these lineup members.  Add any as an attraction, and we'll notify you if we determine the feeling is mutual or not.  Your attractions receive a similar lineup of other potential admirers - with you randomly inserted in it.  Your identity remains protected if you're not picked.  
	{% endif %}
</div>

<div id="bx-pager-container">
	<div id="bx-pager">
		{% for member in member_set %}
		
			{% if member.decision != None or forloop.counter0 == 0 %}
				<a data-slide-index="{{forloop.counter0}}" href=""><img src="http://graph.facebook.com/{{member.username}}/picture?width=50&height=50" /><span {% if member.decision == 0 %}class="decision_crush"{% elif member.decision > 0 %}class="decision_platonic"{% endif %}></span></a>
			{% else %}
					<img class="locked_lineup_pic" lineup_position={{forloop.counter0}} title="you cannot jump ahead in the lineup" src="/static/images/fb_unknown_user_pic.jpg"/>
			{% endif %}
		{% endfor %}
		<span id="lineup_member_board"></span><span id="lineup_member_pointer"></span>
	</div>  <!--  close off bx-pager div -->
</div>

<!-- Just a shell for the slideshow container -->

<ul class="bxslider" style="display:none">

{% for member in member_set %}
	{% if member.decision != None %}
		
	<li class="preload" lineup_position = {{member.position}} ">
		<div class="slide_container">
		 <span class="lineup_name">{{member.user.first_name}} {{member.user.last_name}}
		 		<!--  <span class="lineup_position_info">({{forloop.counter}} of {{member_set.count}})</span>-->
		 		
		 </span>
	   <span class="lineup_mugshot"><img src="http://graph.facebook.com/{{member.username}}/picture?width=125&height=125" /></span>
	   <span class="lineup_facebook_link"><a href="http://www.facebook.com/{{member.username}}" target="_blank">view facebook profile<span class="view_facebook_icon"></span></a></span>
	   <span class="lineup_decision" username="{{member.username}}">
			{% if member.decision == 0 %}
	       <span class="choice crush">Added as Attraction<!--<span class="date_lineup_member_added">  ({{member.relationship.date_added|date:"SHORT_DATE_FORMAT"}})</span>--></span>
			{% else %}
	       <span class="choice platonic">Not Interested<!--<span class="date_lineup_member_added">({{member.relationship.date_added|date:"SHORT_DATE_FORMAT"}})</span>--></span>
	    	<a href="#" class="platonic_reconsider" add_type="crush" username="{{member.username}}" name="{{member.user.first_name}} {{member.user.last_name}}" member_gender= "{{member.user.gender}}" lineup_position="{{member.position}}">change your mind?</a>
	    {% endif %}
	    </span> <!--   close off decision tag -->
   	</div><!-- close off slide container -->
	{% else %}	
	<li class="lineup" lineup_position="{{member.position}}">
	{% endif %}
</li>

{% endfor %}
</ul>
</div>  <!--  close off lineup_container -->

<div class="ui-dialog-buttonpane lineup-footer">
	<span id="footer-msg"></span>
	<div class="ui-dialog-buttonset">
				<button id="finish-btn" class="site_dialog_button" type="button" disabled>Finish</button>
	</div><!-- close off buttonset -->
</div><!-- close off buttonpane -->
		

<script type="text/javascript">
$(document).ready(function() // handling for the slider
{ 

	/** PROCEDURAL CODE - CREATE IS_LINEUP_PAID GLOBAL
	* create global bool variable for lineup's is_lineup_paid setting
	*/
	window.is_lineup_paid = {% if admirer_rel.is_lineup_paid or is_admirer_type == False %}true{% else %}false{% endif %};
		
			
	/* ----------------------------------------------------------------------
	*		FUNCTION - PROCESS COMPLETED LINEUP
  *		enable finish button and add footer summary message
	*  ---------------------------------------------------------------------- */
	var process_completed_lineup = function(){
		footer_element=$('.lineup-footer');
		footer_element.find('#finish-btn').removeAttr('disabled');
		footer_element.find('#finish-btn').show();
	  footer_msg_element = footer_element.children('#footer-msg');
	  footer_msg_element_html='Your lineup evaluation is complete!'
	 	crush_li_elements = $('.lineup_decision').has('.crush');
	 	total_crushes=crush_li_elements.length;
	 	if (total_crushes > 0){ 
	 		footer_msg_element_html += '<span id="added_attractions_info">Added as attractions (' + total_crushes + '):';
		  crush_li_elements.each(function(index,item){
				footer_msg_element_html += ' ' +$(item).parent().children('.lineup_name').html();
				if (index < (total_crushes - 1))
					footer_msg_element_html += ',';	
		  })
		  footer_msg_element_html += '</span>';
		}
		footer_msg_element.html(footer_msg_element_html);
	};
	
	/* ----------------------------------------------------------------------
	*		FUNCTION - UPDATE FOOTER MESSAGE
  *		called everytime a slide load is completed
	*  ---------------------------------------------------------------------- */
		var updateFooterMsg = function(){
		footer_msg_element=$('.lineup-footer #footer-msg');
		// number of evaluated members
		var decided_li_elements = $('.bxslider li.preload .lineup_decision .choice');	
	 	var total_decisions=decided_li_elements.length;
		// total members
		var total_members="{{member_set.count}}";
	  footer_msg_element.html('<div id="progressing">evaluated ' + total_decisions + ' of ' + total_members + ' members</div>');
	};

	/* ----------------------------------------------------------------------
	*		FUNCTION - LAUNCH SLIDER
  *		Launch the slider at a parameterized position
	*  ---------------------------------------------------------------------- */		

	var launch_slider_at = function(last_loaded_slide){
		window.slider_control = $('.bxslider').bxSlider({
			pagerCustom: '#bx-pager',
			infiniteLoop: false,
			hideControlOnEnd: false,
			speed:800,
			touchEnabled:false,
			//adaptiveHeight:false,
			startSlide: 0,
			slideSelector:'li.preload',
			onLastSlideNext: window.handleLastSlideNext,
			onSlideBefore:window.handleLineupMemberPointer,
			});
		$('#lineup_container').find('.bxslider').show();
		if (last_loaded_slide>0)
			setTimeout(function(){window.slider_control.goToSlide(last_loaded_slide)},500);
		else
			handleLineupMemberPointer();
		updateFooterMsg();
	};	
		
	/* ----------------------------------------------------------------------
	*		FUNCTION - AJAX LOAD NEXT SLIDE
  *		Ajax load the next slide into the DOM
	*  ---------------------------------------------------------------------- */			
	var load_next_slide = function(next_position, callback){
		var load_url = '/ajax_get_lineup_slide/{{admirer_rel.display_id}}/' + next_position + '/{% if is_admirer_type == 0 %}0/{% endif %}';
		window.wait_modal_open();
		$('.bxslider li[lineup_position=' + next_position + ']').load(load_url, function(responseText, textStatus, xhr) {
			window.wait_modal_close();
			if (textStatus!='success'){
				if (xhr.status==405){
					reauthorize_user();
					return;
				}
				$(this).dialog("close");
				window.alert_modal('Lineup Problem', "{{generic_error_message}}", $('.bxslider'));
				return false;
			}
			// load the next thumbnail as well
			var next_username =$(this).find('.lineup_decision').attr("username");
			var new_src = 'http://graph.facebook.com/' + next_username + '/picture?type=large';
			var img_element = $('#bx-pager img[lineup_position=' + next_position + ']')

			img_element.attr('src', new_src).attr('width','50').attr('height','50').attr('title','');	
			img_element.wrap('<a data-slide-index="' + next_position + '" href="">');
			callback(next_position);
				// add the fake next button if we're not at the last slide
			}).attr("class", "preload"); // close off ajax load of next slide
	}; // close off of helper function: load_next_slide
	
	/* ----------------------------------------------------------------------
	*		FUNCTION - RESET SLIDER
  *		reset the slider (if # slides changed) and advance it to last slide
	*  ---------------------------------------------------------------------- */		
	var resetAndAdvanceSlider = function(just_loaded_slide){
		window.slider_control.reInitialize();						
		window.slider_control.goToSlide(just_loaded_slide);
		// use this commented about block if you want to add a delay after deciding on a lineup member and before advancing to next lineup member slide
		//		setTimeout(function(){
	  //		window.slider_control.goToSlide(just_loaded_slide);
		//},1000);
	}; // close off resetAndAdvanceSlider

	/* ----------------------------------------------------------------------
	*		FUNCTION - HANDLE ADD ATTRACTION/Platonic CLICK
  *		handle click to 'add member' as crush or platonic friend
	*  ---------------------------------------------------------------------- */
	window.added_lineup_attraction=null;// set whenever attraction is added - used to know when at least one attraction added
	var attraction_dialog = $("#dialog_attraction_add");
	attraction_dialog.dialog({modal: true, autoOpen: false,width:400, resizable:false,dialogClass:'decision_confirmation_dialog blacktop'});		

	var dialog_attraction_html ='';
	dialog_attraction_html += '<div class="dialog_content_wrapper">';
		dialog_attraction_html += '<p class ="attractor_text first_attractor_text">After adding  <span class="attractor_first_name"></span>, we\'ll try to get <span class="attractor_pronoun_object"></span> signed up so <span class="attractor_pronoun_subject"></span> can take a similar lineup. We\'ll notify you when she responds.<span class="ahelp_icon"></span></p>';
		dialog_attraction_html += '<span class="attractor_name_block"><span class="attractor_image"></span><span class="attractor_full_name"></span><span class="decision_icon"></span></span>';
		//dialog_attraction_html += '<p class="attractor_text second_attractor_text"><i>Note:</i>&nbsp;&nbsp;Neither you nor <span class="attractor_first_name"></span> may know for sure who initiated the original attraction. <i>hmm...</i></p>';
		dialog_attraction_html += '<span id = "attractor_agreement"><input class="attractor_agreement_checkbox" type="checkbox" checked><span id = "attractor_agreement_text">I agree to the </span><a href="/help_terms" target="_blank">terms & conditions</a></input></span>';
	dialog_attraction_html += '</div>';
  var platonic_dialog = $("#dialog_platonic_add");
	platonic_dialog.dialog({modal: true, autoOpen: false,resizable:false,width:410,dialogClass:'decision_confirmation_dialog blacktop'});
  var dialog_platonic_html = '<div class="dialog_content_wrapper">';
 		dialog_platonic_html += '<span class="attractor_text">Although you\'re not attracted to <span class="attractor_first_name"></span>, please let us know how you would rate <span class="attractor_pronoun_object"></span> attractiveness to a friend:</span>';
		dialog_platonic_html += '<span class="attractor_name_block"><span class="attractor_image"></span><span class="attractor_full_name"></span><span class="decision_icon"></span></span>';
		dialog_platonic_html += '<div id="platonic_rating_group">';
			dialog_platonic_html += '<span class="platonic_rating"><input type="radio" name="rating" value="5"checked><span class="rating_description">{{rating5}}</span></span>';
			dialog_platonic_html += '<span class="platonic_rating"><input type="radio" name="rating" value="4"><span class="rating_description">{{rating4}}</span></span>';
			dialog_platonic_html += '<span class="platonic_rating"><input type="radio" name="rating" value="3"><span class="rating_description">{{rating3}}</span></span>';
			dialog_platonic_html += '<span class="platonic_rating"><input type="radio" name="rating" value="2"><span class="rating_description">{{rating2}}</span></span>';
	  	dialog_platonic_html += '<span class="platonic_rating"><input type="radio" name="rating" value="1"><span class="rating_description">{{rating1}}</span></span>';
	  dialog_platonic_html += '</div>';
 	dialog_platonic_html += '</div>';
  
  	// this allows the inputs to be clickable on the next confirmation dialog opening
  attraction_dialog.on('click', function(e){e.stopPropagation();});
  platonic_dialog.on('click', function(e){e.stopPropagation();});
  
  $('#lineup_container ').on('click','a.decision,a.platonic_reconsider',function(e) {
	  e.preventDefault();
	  var this_element = $(this);
	  var slide_number = this_element.closest('li.preload').attr('lineup_position'); // this is used to find the associated thumbnail to modify if a decision is made
	  var decision_div = this_element.parent(); 
	  var url,decision_dialog,crush_decision;
	  var username=this_element.attr('username');
	  var full_name=this_element.attr('name');
	  var first_name = full_name.substr(0,full_name.indexOf(' '));
	  if (first_name=="")
	  	first_name=full_name;
	  var gender_pronoun_object = "them";
	  var gender_pronoun_subject = "they";
	  var gender_attribute = this_element.attr('member_gender');
	  if (gender_attribute == 'M'){
	  	gender_pronoun_subject = "he";
	  	gender_pronoun_object = "him";
	  }
	  else if (gender_attribute == 'F'){
	  	gender_pronoun_subject = "she";
	  	gender_pronoun_object = "her";
	  }
	  	  	
	  if (this_element.attr('add_type')=="crush") {
	  	url = "/ajax_add_lineup_member/crush/{{admirer_rel.display_id}}/" +  username + "/{% if is_admirer_type == 0 %}3/0/{% endif %}"; 
	  	decision_dialog = attraction_dialog;
	  	decision_dialog.html(dialog_attraction_html);
	  	if (window.added_lineup_attraction){
	  			decision_dialog.find('.attractor_text').remove();
	  		}
	  	crush_decision=true;
	  }
	  else {
	  	url = "/ajax_add_lineup_member/platonic/{{admirer_rel.display_id}}/" + username + "/"; 
	  	decision_dialog = platonic_dialog;
	  	decision_dialog.html(dialog_platonic_html);
	  	crush_decision=false;
	  }

	  // substitute in the actual attractor names into the dialog
	  decision_dialog.find('.attractor_first_name').html(first_name);
	  decision_dialog.find('.attractor_full_name').html(full_name);
	  decision_dialog.find('.attractor_pronoun_object').html(gender_pronoun_object);
	  decision_dialog.find('.attractor_pronoun_subject').html(gender_pronoun_subject);		
	  decision_dialog.find('.attractor_image').html('<img src="http://graph.facebook.com/' + username + '/picture?width=60&height=60" />');
	  decision_dialog.dialog({buttons: {
				"Cancel": function() {	
					$(this).dialog("close");
				}, // end of cancel handler
				"Confirm": function() {
					if (crush_decision==true){
						var closest_ui_dialog = $(this).closest(".ui-dialog");
					 	if (closest_ui_dialog.find('.attractor_agreement_checkbox').attr('checked') != 'checked'){
							window.alert_modal('Terms & Conditions Agreement', "You must agree to the terms and conditions before continuing.", decision_dialog);
							return;
						}
					}
					else {
						url += decision_dialog.find('input:radio[name="rating"]:checked').val();
						{% if is_admirer_type == 0 %}
							url += "/0/";
						{% endif %}
					}	
					decision_div.prev().show();decision_div.hide();
					decision_div.load(url, function(responseText,textStatus,XHR){
						decision_div.prev().hide();decision_div.show()
						if (textStatus!='success'){					
							window.alert_modal('Lineup Decision', "{{generic_error_message}}", decision_dialog);
							return false;
						};
						if (crush_decision==true){
							window.added_lineup_attraction=true;
							// show crush icon in the associated thumbnail
							$('#bx-pager-container #bx-pager a[data-slide-index="' + slide_number + '"]').append('<span class="decision_crush"></span>');
						}
						else{
							// show platonic icon in the associated thumbnail
							$('#bx-pager-container #bx-pager a[data-slide-index="' + slide_number + '"]').append('<span class="decision_platonic"></span>');
						}
						if (this_element.attr('class') != 'platonic_reconsider')
							goto_next_slide(decision_div.parents('li').attr('lineup_position'));
						}); // close off parent.load (making the decision and showing the html results		
					$(this).dialog("close"); // must destroy rather than close cause switching between two dialogs causes problems
					if (crush_decision==true) 
						$("#num_crushes_in_progress").load("/ajax_update_num_crushes_in_progress/");
					else 
						$("#num_platonic_friends").load("/ajax_update_num_platonic_friends/");
				}   // end of add handler
			},
			open:function(event,ui) {
				var closest_ui_dialog = $(this).closest(".ui-dialog");
				// style each button except cancel button (assuming cancel button is called 'Cancel')
				closest_ui_dialog.find('.ui-button').each(function(counter,element){
					$(element).addClass("site_dialog_button")
					if ($(element).find('span').html()=='Cancel')
						$(element).addClass("site_dialog_cancel_button")
				});
    	}
    }); // end of .dialog handler
    
    decision_dialog.dialog("open");
    $(':focus').blur();

	}); // end of click handler: $('#lineup_container li').on('click','a.decision',function(e)
	
	var goto_next_slide = function(current_position)
	{

		var next_position = parseInt(current_position) + 1;
		if (next_position < {{member_set.count}})	{
			updateFooterMsg();
			// if the slide that was just decided on was the second one and is_lineup_paid=false, then auto launch the check dialog 
			if (current_position == 0 && !window.is_lineup_paid && {{member_set.count}} > 1)
				setTimeout(window.launch_credit_check,1000);
			else 
				load_next_slide(next_position.toString(), resetAndAdvanceSlider);	
		} // close off - if not at last slide
		else // enable finish button
			process_completed_lineup();
	};
	
	/* ----------------------------------------------------------------------
	*		FUNCTION - HANDLE SLIDER LAST NEXT CLICK
  *		callback handler for slider called when last next button is clicked
  *   checks to see if check-payment dialog should be launched (on second slide if lineup_paid is false)
	*  ---------------------------------------------------------------------- */
	window.handleLastSlideNext = function(activeSlideElement,activeIndex){
		// if active slide is last slide (which is 1) and no decision has been made yet, then launch credit check
		if (activeIndex == 0 && activeSlideElement.has('.choice').length && !window.is_lineup_paid){
			window.launch_credit_check();
		}
		else {
			slide_decision = activeSlideElement.find('.lineup_decision .choice');
			if (slide_decision.length)
				goto_next_slide(activeIndex);
			else { 
				var member_name = activeSlideElement.find('.lineup_name').html();
				window.alert_modal('Lineup Enforcement', "Please make a decision on " + member_name + " before jumping ahead.", $('.lineup_modal_dialog'));
			}
		}
	};
	/* ----------------------------------------------------------------------
	*		FUNCTION - HANDLE LINEUP MEMBER POINTER
  *		move it when slide is about to move
	*  ---------------------------------------------------------------------- */

	window.handleLineupMemberPointer = function(activeSlideElement,activeIndex){
		var data_slide_index = $(activeSlideElement).attr('lineup_position');
		if (!data_slide_index)
			data_slide_index=0;
		var x_position= $('#bx-pager a[data-slide-index="'+data_slide_index+'"]').position().left;
		display = (parseInt(data_slide_index) + 1).toString() + ' of 10';
		$('#lineup_member_board').html(display);
		$('#lineup_member_board').animate({left:(x_position+1)},800,'easeOutSine');
		$('#lineup_member_pointer').animate({left:(x_position+11)},800,'easeOutCubic');
		};
	
	/** PROCEDURAL CODE
	* Preload any slides that already have a decision
	*/

	var last_loaded_slide = $('.bxslider li.preload').length - 1;
	//var last_loaded_slide=-1;
	//$('.bxslider li.preload').each(function(index){
	//		$(this).load('/ajax_get_lineup_slide/{{admirer_rel.display_id}}/' + index + '/');	
	//		last_loaded_slide = index;
	//});

	/** PROCEDURAL CODE
	* possibly load the next upcoming slide if we are at first position or if lineup is already paid
	* then call the slider launching function
	*/
	window.startup_slider = function(){
	var next_loaded_slide=last_loaded_slide+1;
	if (next_loaded_slide < {{member_set.count}}) { // we haven't decided on last member yet
		if (last_loaded_slide < 0 || window.is_lineup_paid ) 	// we've only loaded 0 or 1 slide or lineup already paid, so load next automatically
				load_next_slide(next_loaded_slide,launch_slider_at);
		else // don't load slide after last, just open slider at last loaded position
				launch_slider_at(last_loaded_slide);		
	} // lineup isn't paid so just open slider with whatever was already decided
	else{
		launch_slider_at(0);
		process_completed_lineup(); // if lineup is finished then just process it
	}
	};
	/* ----------------------------------------------------------------------
	*		FUNCTION - LAUNCH_CREDIT_CHECK
	*  ---------------------------------------------------------------------- */    
 	
 	window.launch_credit_check = function() {
		data = {};
		data['csrfmiddlewaretoken']="{{csrf_token}}";
		data['success_path'] = '/admirers/{{admirer_rel.display_id}}/';
		data['cancel_url'] = 'http://{{request.get_host}}/admirers/{{admirer_rel.display_id}}';
		data['unique_id'] = '{{admirer_rel.display_id}}';
		data['feature_id'] = '1';
		data['purchase_callback_name'] = 'window.lineup_purchased()';
		data['ajax_error']='{{ajax_error}}';
		purchase_feature(data);
   }; 
   
 	window.lineup_purchased = function(){
			$('#num_new_admirers').load('/ajax_update_num_new_admirers');
			next_position=parseInt(window.slider_control.getCurrentSlide()) + 1;
			load_next_slide(next_position,resetAndAdvanceSlider);
			window.is_lineup_paid=true;
		}; 
	 

	/* ----------------------------------------------------------------------
	*		FUNCTION - HANDLE FINISH BUTTON 
  *		
	*  ---------------------------------------------------------------------- */

	window.handle_lineup_dialog_close = function(){
		var current_href=document.location.href;
	 	var total_decisions=$('.bxslider li.preload .lineup_decision .choice').length;
	 	var attraction_json = {};
	 	var redirect_url='';
	 	var num_new_attractions=0;
		$('.bxslider li .slide_container .lineup_decision .new_crush').each(function(){
			attraction_json[$(this).attr('username')]=$(this).attr('fullname');
			num_new_attractions++;
			});

		if (current_href.indexOf("/admirers/") != -1) { // if user is on progressing admirers page, not on completed admirers page:
			// redirect user to crushes in progress if there is only one progressing lineup and it is done
				if (total_decisions == {{member_set.count}} && {{ request.user.get_progressing_admirers.count }} == 1)	
					redirect_url='/attractions/';
				if (num_new_attractions){
					$('#lineup_modal').dialog("close");//closing of lineup modal automatically refreshes page
					window.launch_invite_interstitial(attraction_json,redirect_url);
					return;
			}
		}
		if (current_href.indexOf("/setups_for_me/") != -1) {
				// redirect user to crushes in progress if there is only one progressing lineup and it is done
				if (total_decisions == {{member_set.count}} && {{ request.user.get_progressing_setups_for_me.count }} == 1)	
					redirect_url='/attractions/';
				if (num_new_attractions){
					$('#lineup_modal').dialog("close");//closing of lineup modal automatically refreshes page
					window.launch_invite_interstitial(attraction_json,redirect_url);
					return;
			}
		}
		$('#lineup_modal').dialog("close");//closing of lineup modal automatically refreshes page
		window.location.href=redirect_url;
	};
	$('#lineup_modal').on('click','#finish-btn',function(e) {
		window.handle_lineup_dialog_close();
	});
}); // close off jquery document ready

</script>



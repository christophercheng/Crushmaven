{% extends "base.html" %}
{% block title %}Attractions{% endblock %}
{% block content %}
{% load fbdater_extras %}
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-38751299-1']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>
<script type="text/javascript">
$(document).ready(function() 
{

	/* ----------------------------------------------------------------------
	*		FUNCTION - LAUNCH_CREDIT_CHECK
	*  ---------------------------------------------------------------------- */    
 	
  $("a.check_credit").click(function(e) {

		data = {};
		data['csrfmiddlewaretoken']="{{csrf_token}}";
		data['success_path'] = $(this).attr('success_path');	
		data['cancel_url'] =  $(this).attr('cancel_url');
		var unique_id = $(this).attr('unique_id');
		data['unique_id'] = unique_id;
		data['feature_id'] = $(this).attr('feature_id');
		data['purchase_callback_name'] = 'window.display_response_modal(' + unique_id + ')';
		data['ajax_error']='{{ajax_error}}';
		window.purchase_feature(data);
		
   }); 

 /* ---------------------------------------------
 	
 		RESPONSE MODAL DIALOG AND HANDLER
 	
 * -------------------------------------------- */
  
  $("#response_modal").on('click', '#response_send_message', function(e){
  	e.preventDefault();
	   var crush_id = $(this).attr('crush_id');
	   //$(this).parent().dialog("close"); 	 
	   // ok to always purchase conversation cause if you're coming from the response dialog then you haven't paid yet
	   window.purchase_conversation("{{csrf_token}}",crush_id);
  });
  
  $("#response_modal").dialog({dialogClass:'response_modal_dialog',modal: true,resizable:false, autoOpen: false,width:350,close:function(event,ui){location.href="/attractions_completed/";}});
  
  	window.display_response_modal = function(crush_id) {
   	load_url="/ajax_load_response_dialog_content/" + crush_id + "/";
    
    $("#response_modal").html('<span id="site-loading-fill"><div id="site-loading"></div></span>');
	$("#response_modal").dialog('option', 'buttons', {
		"Ok": function() {$(this).dialog("close");redirect_after_response_viewed();}
	});
	
	 $("#response_modal").load(load_url,function(responseText,textStatus,XHR){
		if (textStatus!='success'){
			$(this).html("{{ajax_error}}");
			return false;
		}
	});
    $("#response_modal").dialog("open");
    return false;
   };
   
   
   $(".response_view_rating a").click(function(){
   		unique_id=$(this).attr('unique_id');
	   	purchase_rating(unique_id);
   });
   
   $("#response_modal").on('click','.response_view_rating a',function(){
		unique_id=$(this).attr('unique_id');
		purchase_rating(unique_id);
   });

	var purchase_rating = function(unique_id){
   		data = {};
			data['csrfmiddlewaretoken']="{{csrf_token}}";
			data['success_path'] = '/attractions_completed/' +  '/' + unique_id + '/';
			data['cancel_url'] = 'http://{{request.get_host}}/attractions_completed/' +  '/' + unique_id + '/';
			data['unique_id'] = unique_id;
			data['feature_id'] = '3';
			data['purchase_callback_name'] = 'window.rating_purchased(' + unique_id + ')';
			data['ajax_error']='{{ajax_error}}';
			purchase_feature(data); // purchase_feature is a function in external js file
	};

 	window.rating_purchased = function(unique_id){
			var rating,html;
			$.get('/ajax_get_platonic_rating/' + unique_id, function(rating){
					rating_element = $('.response_view_rating');
					rating_element.html(rating);
				}).fail(function(){
					window.alert_modal('Attraction Response Problem', "{{generic_error_message}}");
					return;
					});
		}; 
   
 	// auto call previously defined display_response_modal if there is a server value 
 	{% if reveal_crush_id %}
 		display_response_modal('{{reveal_crush_id}}');
 	{% endif %}

 /* ---------------------------------------------
 	
 		ADMIN DELETE DIALOG AND HANDLER
 	
 * -------------------------------------------- */

 
  	window.remove_crush_dialog = $("#remove_crush_dialog").dialog({dialogClass: 'delete_crush_dialog blacktop',modal: true, autoOpen: false});
  	// call ajax function to see if deletion if possible, if not then raise alert
  	//   if possible to delete, then confirm action with user before making second ajax call to actually perform the delete
   
    $("a.delete_crush").click(function(e) {
		$(this).parents('ul').css('display','none');
  		var name=$(this).attr('name');	
  		var username=$(this).attr('username');
    
  		$.get('/ajax_can_crush_target_be_platonic_friend/' + username + '/', function(){
    		// deletion is possible, so open up the confirmation dialog
    		window.remove_crush_dialog.dialog("open");
    	      $(':focus').blur();
    	}).fail(function(response){
 				window.alert_modal('Attraction Removal', response.responseText );
 				return false;
		});  
    
      e.preventDefault();
      window.remove_crush_dialog.text("Are you sure you want to remove " + name + " from your crush list?  Maybe you should give it just a bit more time?");
      window.remove_crush_dialog.dialog('option', 'buttons', {
    		"Cancel": function() {$("#remove_crush_dialog").dialog("close");
      		},
      		"Delete": function() {
 				$.get('/ajax_make_crush_target_platonic_friend/' + username + '/',function(){
 					document.location.href='/attractions/'; // reload page
 				}).fail(function(response){
 				 	window.remove_crush_dialog.dialog("close");
 				 	window.alert_modal('Attraction Removal', "{{generic_error_message}}" );
 				});
 			}
  		});
      $('.delete_crush_dialog .ui-button').addClass('site_dialog_button');
      $(".delete_crush_dialog .ui-button:nth-child(1)").addClass("site_dialog_cancel_button");
      return false;
  });

 /* ---------------------------------------------
 	
 		CRUSH NAME LINK HANDLER
 	
 * -------------------------------------------- */

$('.crush_name_link').click(function(){
	menu_element = $(this).parent('.crush_block_name_center').children('ul');
	var original_state = $(menu_element).css('display');
	$('.popup').hide(); // hide all other popups
	if (original_state != 'block')
		$(menu_element).toggle();
});
  
 /* ---------------------------------------------
 	
 		FACEBOOK PRIVACY SETTINGS CHECK MODAL DIALOG AND HANDLER
 	
 * -------------------------------------------- */
  
  $("#privacy_check_modal").dialog({modal: true,resizable:false, autoOpen: false});
  $("#privacy_check").click(function(e) {
    e.preventDefault();
    $("#privacy_check_modal").html("Your Facebook privacy setting for this app's visibility is currently NOT set to <i>Only Me</i>. <BR><BR>In order to conceal your identity from your attraction, we strongly urge you to change your settings immediately. <BR><BR> <a href='/help_fb_privacy_setting/' target='_blank'>Learn how here.</a> <BR><BR>");
		$('#privacy_check_modal').dialog("open");
  	return false;
  });
  
  {% if check_fb_privacy_setting %}
  //check for privacy setting value
	var query_string= 'SELECT name,value FROM privacy_setting WHERE name="default_stream_privacy"';
	url = 'https://graph.facebook.com/fql?q=' + query_string + '&access_token={{request.user.access_token}}&callback=?';
  privacy_fetch = $.getJSON(url);
  privacy_fetch.done(function(response){
  	if(response.data[0]['value'] != 'SELF')
     $("#privacy_check").trigger('click');
   });
  {% endif %}  	

//$('.crush_block .progress_bar_canal .progress_bar').animate({width:$(this).attr('width')},3500);
$.each($('.crush_block .progress_bar_canal .progress_bar'),function(){
	var attr_width = $(this).attr('width');
	var animate_property = {width:attr_width+'px'};
	var ease_function;
	if (attr_width == '505')
		ease_function = "easeOutQuart";
	else
		ease_function = "easeOutBack"; 
	
	var duration;
	if (attr_width>500)
		duration = 1000;
	else
		duration = 2000*(attr_width/505);//Math.floor((Math.random()*1500)+1000);
	 
	$(this).delay(1000).animate(animate_property,duration,ease_function,function(){
		var status_bar = $(this).parent().parent().find('.attraction_status_bar');
		status_bar.children('li.active_status').addClass('active_status_animated');
		status_bar.children('li.past_status').addClass('past_status_animated');
		});
	});      
});
</script>

<!-- ALWAYS display responded crush relationships on top of page, if they exist -->

{% if responded_relationships %}

<div id ="responses">
	<span id="title_new_responses">You have new responses!</span>
	{% for crush in responded_relationships %}
			{% with crush as crush %}
				 	{% include "crush_block.html" %}
				{% endwith %}
	{% endfor %} 
</div>
{% endif %} 

<!-- Display the crush type navigation widget -->  
<ul class="title_bar" id="title_bar_attractions">
	<li class="title_bar_title">Your Likes</li>
	<li class="title_bar_page_links">
		{% if crush_type == 0  %}
			<span class="title_bar_page_link active_title_bar_page_link title_bar_page_first_link ">not responded<span class="title_bar_count">{{crushes_in_progress_count}}</span></span>
			<a class="title_bar_page_link inactive_title_bar_page_link" href="/attractions_completed/">responded<span class="title_bar_count">{{crushes_completed_count}}</span></a>
		{% else %}
			<a class = "title_bar_page_link inactive_title_bar_page_link title_bar_page_first_link " href="/attractions/">not responded<span class="title_bar_count">{{crushes_in_progress_count}}</span></a>
			<span class="title_bar_page_link active_title_bar_page_link">responded<span class="title_bar_count">{{crushes_completed_count}}</span></span>
		{% endif %}
	</li>
		<li class="title_bar_option">
		sort:
		<a href="#">by status<span class="down_arrow">&#x25BC;</span></a>
	</li>
</ul>
<! -- End of crush type navigation widget --> 

{% if show_help_popup == True %}
<div class="new_user_instructions">
	<span class="help_icon" title="close help"></span>
	<span class="instructions_title">How Liking Someone Works</span>
	<div class="first_instruction_section">
		<div class="instruction_step"><span class="help_icon2">1</span><span class="instruction_step_text">'Like' any Facebook friend <i>(or anyone on Facebook)</i> that you're attracted to.</span></div>
		<div class="instruction_sub_step"><span class="instruction_step_text">(Your likes are completely private.  Not even your friends will know.)</span></div>
		<div class="instruction_step"><span class="help_icon2">2</span><span class="instruction_step_text">Send your Likes an <i>anonymous</i> invite to sign into Flirtally.</span></div>
		<a class="show_more">show more</a><a class="show_less">show less</a> 
		 
	</div>
	<div class="second_instruction_section">
		<div class="instruction_step"><span class="help_icon2">3</span><span class="instruction_step_text">Once signed in, your Likes receive a carefully constructed lineup of potential admirers, including you.  They'll pick out the ones they're attracted to.</span></div>
		<div class="instruction_sub_step"><span class="instruction_step_text">(Because the lineup is randomly ordered, your identity as the actual admirer is anonymous.)</span></div>
		<div class="instruction_step"><span class="help_icon2">4</span><span class="instruction_step_text">We'll let you know whether you're picked (or not). Your Likes may not even realize that you liked them first!</span></div>
	</div>
	<div class="instruction_block_button_line">
		<a href="javascript:{}" class="bt-fs-dialog instruction_block_button" title="Add an Attraction">Like Someone</a>
	</div>
	</div>		<!-- close off instructional content -->
	{% if crushes_in_progress_count == 0 %}
		<p class="new_user_sub_instructions">
			<span class="sub_instruction_strong">Already in a relationship?</span>&nbsp;&nbsp;Or just more interested in matchmaking through friends?&nbsp;&nbsp;Check out our <a href="/setups_by_you/">Friend Setups</a>
		</p>
	{% endif %}
{% endif %} 

{% if crush_relationships %}
	{% for crush in crush_relationships %}
		{% with crush as crush %}
				 	{% include "crush_block.html" %}
				{% endwith %}
	{% endfor %}

{% elif show_help_popup == False %}

<span id="no_content">

	{% if crush_type == 0 %}
		You have no {% if responded_relationships %} <i>ongoing</i> {% endif %}attractions.<span class="no_content_action"><a href="javascript:{}" class="bt-fs-dialog">Add one</a> to get started.</span>
	{% else %}
		You have no <i>responded</i> attractions.&nbsp;&nbsp;<span class="no_content_action"><a href="javascript:{}" class="bt-fs-dialog">Add one</a> to get started.</span>
	{% endif %}
	</span>
{% endif %}
<div id="remove_crush_dialog" title="Remove Crush"></div>
<div id="privacy_check_modal" title="Facebook Privacy Setting Warning"></div>
<div id="privacy_check"></div>
<div id="response_modal" title = "Your Attraction's Response"></div>
{% endblock %}
